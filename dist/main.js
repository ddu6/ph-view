(()=>{"use strict";const e=32859,t=[""],n=[];async function s(e,t={},n={},s="",i=""){let o=new URL(e).searchParams.toString();o.length>0&&(o+="&"),o+=new URLSearchParams(t).toString(),o.length>0&&(o="?"+o),e=new URL(o,e).href;const a=new URLSearchParams(n).toString(),r={};s.length>0&&(r.Cookie=s),i.length>0&&(r.Referer=i);const c={method:a.length>0?"POST":"GET",headers:r,referrerPolicy:"no-referrer"};return a.length>0&&(Object.assign(r,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}),Object.assign(c,{body:a})),await new Promise((async t=>{setTimeout((()=>{t(500)}),6e4);const n=await fetch(e,c),{headers:s,status:i}=n;if(200===i){try{const e=await n.text();t({status:i,body:e,headers:s})}catch(e){console.log(e)}t(500)}else t(i)}))}async function i(e={},t={}){Object.assign(e,{PKUHelperAPI:"3.0",jsapiver:"201027113050-"+2*Math.floor(Date.now()/72e5)});const n=await s("https://pkuhelper.pku.edu.cn/services/pkuhole/api.php",e,t);if("number"==typeof n)return n;const{status:i,body:o}=n;if(200!==i)return i;try{const{code:e,data:t,msg:n}=JSON.parse(o);if(0===e)return{data:t};if("没有这条树洞"===n)return 404;if("已经关注过了"===n)return 409;"string"==typeof n&&n.length>0&&(n.startsWith("你已被禁言")?alert(n):console.log(n))}catch(e){console.log(e)}return 500}async function o(e,t={}){return await new Promise((async n=>{let s=new URLSearchParams(t).toString();s.length>0&&(s="?"+s),setTimeout((()=>{n(503)}),6e4);try{const t=await fetch(`https://ddu6.xyz/services/ph-get/${e}${s}`);if(200!==t.status)return void n(500);const{status:i,data:o}=await t.json();if(200===i)return void n({data:o});if("number"==typeof i)return void n(i)}catch(e){console.log(e)}n(500)}))}async function a(e,t,n){return await o(`local/cs${e}`,{token:t,password:n})}async function r(e,t,n){if(0===n.length)return 403;e=Number(e);const s=await o(`local/c${e}`,{token:t,password:n});return 403===s?403:404===s?404:503===s?503:"number"==typeof s?500:s.data}async function c(s,a,r){let c=404;if((s=Number(s))>e&&!n.includes(s)&&(c=await async function(e,t){return await i({action:"getone",pid:e.toString(),user_token:t})}(s,a),404===c&&n.push(s)),404===c){if(0===r.length)return 404;if(c=await async function(e,t,n){return await o(`local/h${e}`,{token:t,password:n})}(s,a,r),"number"!=typeof c&&(c.data.hidden=1),403===c)return 403}if(401===c)return 401;if(503===c)return 503;if(404===c)return 404;if("number"==typeof c)return 500;const h=c.data;return 0===Number(h.timestamp)?404:(t.includes(r)||1===Number(h.hidden)||403===await async function(e,t,n){return await o(`h${e}`,{update:"",token:t,password:n})}(s,a,r)&&t.push(r),h)}async function h(e){const t=await i({action:"getattention",user_token:e});return 401===t?401:503===t?503:404===t?[]:"number"==typeof t?500:t.data}async function l(t,s,o){if((t=Number(t))<=e||n.includes(t))return 500;const a=await i({action:"attention",pid:t.toString(),switch:s?"0":"1",user_token:o});return"number"!=typeof a?200:503===a?503:409===a?409:500}async function d(t,s,o){if((t=Number(t))<=e||n.includes(t))return 500;const a=await i({action:"docomment",user_token:o},{pid:t.toString(),text:s,user_token:o});return"number"!=typeof a?200:503===a?503:500}async function m(e,n,s,a,r,c,h){if("id"!==s){if(0===h.length)return 403;const t=await async function(e,t,n,s,i,a,r){return await o(`local/p${t}`,{key:e,order:n,s:s.toString(),e:i.toString(),token:a,password:r})}(e,n,s,a,r,c,h);if(401===t)return 401;if(403===t)return 403;if(503===t)return 503;if("number"==typeof t)return 500;const i=t.data;if("active"===s&&i.length>0){let{etimestamp:e}=i[0];if("string"==typeof e&&(e=Number(e)),"number"==typeof e){const t=window.localStorage,n=t.getItem("ph-max-etimestamp");null!==n?e>Number(n)&&t.setItem("ph-max-etimestamp",e.toString()):t.setItem("ph-max-etimestamp",e.toString())}}return i}const l=await async function(e,t,n){return 0===e.length?await async function(e,t){return await i({action:"getlist",p:e.toString(),user_token:t})}(t,n):await async function(e,t,n){return await i({action:"search",pagesize:"50",page:t.toString(),keywords:e,user_token:n})}(e,t,n)}(e,n,c);if(401===l)return 401;if(404===l)return[];if(503===l)return 503;if("number"==typeof l)return 500;const d=l.data;if(d.length>0){t.includes(h)||403===await async function(e,t,n,s){return await o(`p${t}`,{update:"",key:e,token:n,password:s})}(e,n,c,h)&&t.push(h);let{pid:s,timestamp:i}=d[0];"string"==typeof s&&(s=Number(s));const a=window.localStorage,r=a.getItem("ph-max-id");null!==r?s>Number(r)&&a.setItem("ph-max-id",s.toString()):a.setItem("ph-max-id",s.toString()),"string"==typeof i&&(i=Number(i));const l=a.getItem("ph-max-etimestamp");null!==l?i>Number(l)&&a.setItem("ph-max-etimestamp",i.toString()):a.setItem("ph-max-etimestamp",i.toString())}return d}class A{constructor(e=[],t="div"){this.element=document.createElement(t),this.classList=this.element.classList,this.style=this.element.style;for(let t=0;t<e.length;t++){const n=e[t].replace(/\s/g,"-");if(""!==n)try{this.element.classList.add(n)}catch(e){console.log(e)}}}append(...e){return this.element.append(...e.map((e=>e instanceof A?e.element:e))),this}prepend(...e){return this.element.prepend(...e.map((e=>e instanceof A?e.element:e))),this}after(...e){return this.element.after(...e.map((e=>e instanceof A?e.element:e))),this}before(...e){return this.element.before(...e.map((e=>e instanceof A?e.element:e))),this}setText(e){return this.element.textContent=e,this}setHTML(e){return this.element.innerHTML=e,this}addEventListener(e,t,n){return this.element.addEventListener(e,t,n),this}}class p extends A{constructor(e,t,n="div"){super([e,t],n),this.name=e,this.type=t;try{this.element.dataset.name=e}catch(e){console.log(e)}}}class u extends p{constructor(e){super(e,"checkbox")}}class g extends p{constructor(e){super(e,"button")}}class f extends p{constructor(e){super(e,"form-line")}}class w extends p{constructor(e){super(e,"form")}}class k extends w{constructor(){super("hole"),this.index=new A(["index"]),this.text=new A(["text"]),this.attachment=new A(["attachment"]),this.commentsEle=new w("comments"),this.checkboxes={comment:new u("comment"),star:new u("star"),refresh:new u("refresh"),send:new u("send")},this.textareas={comment:document.createElement("textarea")},this.forms={comment:new w("comment")},this.restComments=[],this.comments=[],this.commentLimit=50,this.toNameRegExp=/^Re [\w\s]*:\s*$/,this.isRef=!1,this.id=-1,this.commentNum=0,this.reverse=!1,this.maxETimestamp=0,this.focusName="",this.append(this.index).append(this.text).append(this.attachment).append(new A(["tools"]).append(this.checkboxes.comment).append(this.checkboxes.star).append(this.checkboxes.refresh)).append(this.forms.comment.append(this.textareas.comment).append(this.checkboxes.send)).append(this.commentsEle),this.forms.comment.classList.add("hide"),this.checkboxes.comment.addEventListener("click",(async e=>{const{classList:t}=this.checkboxes.comment;t.contains("checked")?(this.forms.comment.classList.add("hide"),t.remove("checked")):(this.forms.comment.classList.remove("hide"),t.add("checked"))})),this.checkboxes.star.addEventListener("click",(async e=>{const{classList:t}=this.checkboxes.star;t.contains("checking")||(t.add("checking"),await this.handleStar(),t.remove("checking"))})),this.checkboxes.refresh.addEventListener("click",(async e=>{const{classList:t}=this.checkboxes.refresh;if(t.contains("checking"))return;const{classList:n}=this.element;this.reverse=!this.reverse,t.add("checking"),n.add("refreshing"),await this.handleRefresh(),n.remove("refreshing"),t.remove("checking")})),this.checkboxes.send.addEventListener("click",(async e=>{const{classList:t}=this.checkboxes.send;if(t.contains("checking"))return;const{classList:n}=this.element;t.add("checking"),n.add("refreshing"),await this.handleSend(),n.remove("refreshing"),t.remove("checking")}))}render(e,t,n,s,i,o){this.isRef=n,this.maxETimestamp=o,n?this.element.classList.add("ref"):this.element.classList.remove("ref");let{text:a,tag:r,pid:c,timestamp:h,reply:l,likenum:d,type:m,url:A,etimestamp:p,hidden:u}=e;1===Number(u)?this.element.classList.add("hidden"):this.element.classList.remove("hidden"),"string"!=typeof a&&(a=""),"string"!=typeof r&&(r=""),this.id=Number(c),this.commentNum=Number(l);let g=`<span class="id">${c}</span> ${v(h)}`;if(r.length>0&&(g+=` <span class="tag">${b(r)}</span>`),this.index.element.innerHTML=g,0!==Number(l)&&(this.checkboxes.comment.element.textContent=l.toString()+" "),0!==Number(d)&&(this.checkboxes.star.element.textContent=d.toString()+" "),s?this.checkboxes.star.classList.add("checked"):this.checkboxes.star.classList.remove("checked"),this.text.element.innerHTML=b(a),this.attachment.element.innerHTML="","string"==typeof A&&A.length>0)if("image"===m){const e=document.createElement("img");e.classList.add("dark"),e.src=`https://${t?"ddu6.xyz/ph/imgs":"pkuhelper.pku.edu.cn/services/pkuhole/images"}/${A}`,this.attachment.append(e)}else if("audio"===m){const e=document.createElement("a");e.classList.add("audio"),e.href=`https://${t?"ddu6.xyz/ph/audios":"pkuhelper.pku.edu.cn/services/pkuhole/audios"}/${A}`,e.textContent="Audio",e.target="_blank",this.text.append(e)}"string"==typeof c&&(c=Number(c)),c>i&&this.element.classList.add("new-hole"),"string"==typeof p&&(p=Number(p)),"number"==typeof p&&p>o&&this.element.classList.add("new-comment")}appendComment(e){let{pureText:t,tag:n,timestamp:s,cid:i,name:o,toName:a}=e,r=`${i} ${v(s)}`;"string"==typeof n&&n.length>0&&(r+=` <span class="tag">${b(n)}</span>`),"string"==typeof a&&""!==a&&(r+=` to ${a}`),"string"!=typeof t&&(t=""),"string"!=typeof o&&(o="");const c=new A([]),h=new A(["index"]),l=new A(["content"]),d=new A(["text"]),m=new A(["name"]);return this.commentsEle.append(c.append(m.setText(o+" ")).append(l.append(h.setText(r)).append(d.setHTML(b(t))))),o===this.focusName&&c.classList.add("focus"),c.addEventListener("click",(e=>{this.checkboxes.comment.classList.contains("checked")&&(this.textareas.comment.value.length>0&&null===this.textareas.comment.value.match(this.toNameRegExp)||(this.textareas.comment.value=""!==o&&"洞主"!==o?`Re ${o}: `:""))})),m.addEventListener("click",(e=>{m.classList.contains("checking")||"string"!=typeof o||0===o.length||(m.classList.add("checking"),o===this.focusName?this.unfocus(Number(i)):this.focus(o,Number(i)),m.classList.remove("checking"))})),"string"==typeof s&&(s=Number(s)),"number"==typeof s&&s>this.maxETimestamp&&this.element.classList.add("new-comment"),c}addMoreButton(e){const t=document.createElement("div");this.commentsEle.append(t),t.textContent=`${e} more`,t.classList.add("more"),t.addEventListener("click",(e=>{t.remove(),this.renderRestComments()}))}renderComments(e){e.length>Number(this.checkboxes.comment.element.textContent)&&(this.checkboxes.comment.element.textContent=e.length.toString()+" "),function(e){e.length>=2&&Number(e[0].cid)>Number(e[1].cid)&&e.reverse();const t={};for(let n=0;n<e.length;n++){const s=e[n];if("string"==typeof s.toName)continue;s.toName="";let{text:i,cid:o}=s;"string"!=typeof i&&(i=""),o=Number(o);const a=i.indexOf("]");if("string"==typeof s.name&&0!==s.name.length||(s.name=i.slice(1,a)),t[o]=s.name,i=i.slice(a+1),i.startsWith(" ")&&(i=i.slice(1)),i.startsWith("Re ")){const e=i.indexOf(":");if(-1!==e&&e<30)if(s.toName=i.slice(3,e),i=i.slice(e+1),i.startsWith(" ")&&(i=i.slice(1)),s.toName===s.name||"洞主"===s.toName)s.toName="";else if(s.toName.startsWith("#")){s.toName=s.toName.slice(1);const e=t[Number(s.toName)];e===s.name||"洞主"===e?s.toName="":void 0!==e&&(s.toName=e+" "+s.toName)}}s.pureText=i}}(e),e.length>=2&&this.reverse&&e.reverse(),this.comments=e,this.renderPartialComments(e)}renderPartialComments(e,t){let n,s=this.commentLimit;if("number"==typeof t)for(let n=0;n<e.length;n++)if(Number(e[n].cid)===t){n>=s&&(s=n+1);break}if(this.commentsEle.element.innerHTML="",this.restComments=[],e.length<2*this.commentLimit)for(let s=0;s<e.length;s++){const i=this.appendComment(e[s]);Number(e[s].cid)===t&&(n=i)}else{for(let i=0;i<s;i++){const s=this.appendComment(e[i]);Number(e[i].cid)===t&&(n=s)}this.restComments=e.slice(s),this.addMoreButton(this.restComments.length)}void 0!==n&&n.element.scrollIntoView()}renderRestComments(){if(this.restComments.length<20*this.commentLimit){for(let e=0;e<this.restComments.length;e++)this.appendComment(this.restComments[e]);return void(this.restComments=[])}const e=this.restComments.slice(0,10*this.commentLimit);this.restComments=this.restComments.slice(10*this.commentLimit);for(let t=0;t<e.length;t++)this.appendComment(e[t]);this.addMoreButton(this.restComments.length)}focus(e,t){this.focusName=e,this.renderPartialComments(this.comments.filter((t=>t.name===e||t.toName===e)),t)}unfocus(e){this.focusName="",this.renderPartialComments(this.comments,e)}async handleStar(){}async handleRefresh(){}async handleSend(){}}function b(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\'/g,"&#39;").replace(/\"/g,"&quot;").replace(/(^|[^.@a-z0-9_])((?:https?:\/\/)(?:(?:[\w-]+\.)+[a-z]{2,5}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d{1,5})?(?:\/[\w~!@#$%^&*\-_=+[\]{};:,./?|]*)?)(?![.@a-z0-9_])(?=[^<>]*(<[^\/]|$))/gi,'$1<a href="$2" target="_blank">$2</a>').replace(/(^|[^.@a-z0-9_\/])((?:(?:[\w-]+\.)+[a-z]{2,5}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d{1,5})?(?:\/[\w~!@#$%^&*\-_=+[\]{};:,./?|]*)?)(?![.@a-z0-9_])(?=[^<>]*(<[^\/]|$))/gi,'$1<a href="https://$2" target="_blank">$2</a>').replace(/(\b\d{5,7}\b)(?=[^<>]*(<[^\/]|$))/g,`<a href="${document.location.origin+document.location.pathname}?fillter=%23$1" target="_blank">$1</a>`).replace(/(树洞管理条例)/g,'<a href="https://pkuhelper.pku.edu.cn/treehole_rules.html" target="_blank">$1</a>')}function v(e){const t=new Date(Number(e+"000")),n=new Date,s=t.getFullYear(),i=n.getFullYear(),o=t.getMonth()+1+"/"+t.getDate(),a=n.getMonth()+1+"/"+n.getDate(),r=t.getHours()+":"+t.getMinutes()+":"+t.getSeconds();return s!==i?r+" "+s+"/"+o:a!==o?r+" "+o:r}class x{constructor(e){if(this.e=e,e.targetTouches.length>0){let t=0,n=e.targetTouches[0];for(let s=0;s<e.targetTouches.length;s++){const i=e.targetTouches[s];i.force>t&&(n=i,t=n.force)}this.targetTouch=n}}}class y extends A{constructor(){super(["lr-struct"]),this.side=new A(["side"]),this.button=new g("menu"),this.sideContent=new A(["content"]),this.main=new A(["main"]),this.sash=new A(["sash"]),this.cover=new A(["cover"]),this.sashing=!1,this.sashX=0,this.side.element.append(this.sideContent.element),this.side.element.append(this.cover.element),this.side.element.append(this.sash.element),this.element.append(this.main.element),this.element.append(this.button.element),this.element.append(this.side.element),this.sideWidth=this.side.element.offsetWidth,this.button.addEventListener("mousedown",(e=>{e.preventDefault(),this.side.classList.add("active")})),this.main.addEventListener("mousedown",(e=>{this.side.classList.remove("active")})),this.sash.addEventListener("mousedown",(e=>{e.preventDefault(),this.sashing=!0,this.sashX=e.clientX,this.sideWidth=this.side.element.offsetWidth,this.element.classList.add("sashing")})),this.sash.addEventListener("touchstart",(e=>{this.sashing=!0;const t=new x(e).targetTouch;void 0!==t&&(this.sashX=t.clientX,this.sideWidth=this.side.element.offsetWidth,this.element.classList.add("sashing"))})),document.addEventListener("mousemove",(e=>{if(!this.sashing)return;e.preventDefault();const t=e.clientX-this.sashX,n=Math.min(Math.max(this.sideWidth+t,30),this.element.offsetWidth);this.side.style.width=n+"px",this.main.style.marginLeft=this.side.element.offsetWidth+"px",this.side.element.offsetWidth<=50?this.sideContent.classList.add("vanished"):this.sideContent.classList.remove("vanished")})),this.sash.addEventListener("touchmove",(e=>{if(e.cancelable&&e.preventDefault(),!this.sashing)return;const t=new x(e).targetTouch;if(void 0===t)return;const n=t.clientX-this.sashX,s=Math.min(Math.max(this.sideWidth+n,30),this.element.offsetWidth);this.side.style.width=s+"px",this.main.style.marginLeft=this.side.element.offsetWidth+"px",this.side.element.offsetWidth<=50?this.sideContent.classList.add("vanished"):this.sideContent.classList.remove("vanished")})),document.addEventListener("mouseup",(async e=>{!0===this.sashing&&(this.sashing=!1,this.element.classList.remove("sashing"),await this.handleSash())})),document.addEventListener("touchend",(async e=>{!0===this.sashing&&(this.sashing=!1,this.element.classList.remove("sashing"),await this.handleSash())}))}async handleSash(){}}class L{constructor(){this.queue=[]}async get(e=1e4){return await new Promise((t=>{const n=Symbol(),s={symbol:n,listen:()=>{t(n)},failed:!1};e>0&&setTimeout((()=>{t(!1),s.failed=!0}),e),this.queue.push(s),this.queue[0].symbol===n&&t(n)}))}release(e){if(0!==this.queue.length&&this.queue[0].symbol===e){for(this.queue.shift();this.queue.length>0&&this.queue[0].failed;)this.queue.shift();this.queue.length>0&&this.queue[0].listen()}}}class E{constructor(){this.busy=!1,this.sleepTime=0,this.lock=new L,this.killLock=new L,this.killing=!1,this.killed=!1,this.killedListen=()=>{},this.killingListen=async e=>{},this.queue=[]}async get(e=1e4){return await new Promise((async t=>{const n=Symbol(),s={symbol:n,listen:e=>{e?t(!1):(t(n),this.busy=!0)},failed:!1};e>0&&setTimeout((()=>{t(!1),s.failed=!0}),e);const i=await this.lock.get(-1);if(this.killing||this.killed)return t(!1),void this.lock.release(i);this.queue.push(s),this.queue[0].symbol===n&&(t(n),this.busy=!0),this.lock.release(i)}))}async release(e){const t=await this.lock.get(-1);if(0!==this.queue.length&&this.queue[0].symbol===e){for(this.queue.shift();this.queue.length>0&&this.queue[0].failed;)this.queue.shift();if(this.busy=!1,this.killing||this.killed){for(let e=0;e<this.queue.length;e++)this.queue[e].listen(!0);this.queue=[],this.killedListen()}else this.queue.length>0&&this.queue[0].listen(!1);this.lock.release(t)}else this.lock.release(t)}async kill(e=1e4){const t=await this.killLock.get(-1),n=await new Promise((async t=>{const n=await this.lock.get(-1);this.killing=!0,this.killedListen=()=>{t(!0)};const s=this.queue.length;if(0===s)return this.lock.release(n),void t(!0);e>0&&setTimeout((()=>{t(!1)}),e);const{symbol:i}=this.queue[s-1],o=this.killingListen;this.lock.release(n),await o(i)})),s=await this.lock.get(-1);return this.killed=!0,this.killing=!1,this.lock.release(s),this.killLock.release(t),n}async revive(){const e=await this.killLock.get(-1),t=await this.lock.get(-1);if(!1===this.killed)return this.lock.release(t),void this.killLock.release(e);this.killed=!1,this.queue=[],this.killing=!1,this.busy=!1,this.sleepTime=0,this.lock.release(t),this.killLock.release(e)}async setKillingListen(e,t=(async()=>{})){const n=await this.lock.get(-1);if(0===this.queue.length||this.queue[0].symbol!==e||this.killed)this.lock.release(n);else{if(this.killing)return this.lock.release(n),void await t();this.killingListen=async n=>{e===n&&await t()},this.lock.release(n)}}async sleep(e){await new Promise((async t=>{const n=await this.get(e);!1!==n?(this.sleepTime=e,await this.setKillingListen(n,(async()=>{this.sleepTime=0,await this.release(n),t(!0)})),setTimeout((async()=>{this.sleepTime=0,await this.release(n),t(!0)}),e)):t(!0)}))}async wake(){const e=await this.lock.get(-1),t=this.queue.length;if(this.killing||this.killed||!this.busy||0===this.sleepTime||0===t)return void this.lock.release(e);const{symbol:n}=this.queue[t-1];this.lock.release(e),await this.killingListen(n)}}const S=8e3;document.head.innerHTML="<meta charset='utf8'>\n<meta name='viewport' content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=0'>\n<title>PKU Hole</title>\n<link rel=\"icon\" href=\"https://cdn.jsdelivr.net/gh/ddu6/static@0.1.0/imgs/ph.png\" type=\"image/png\">",document.body.style.margin="0",window.main=new class extends y{constructor(e){super(),this.parent=e,this.flow=new A(["flow"]),this.panel=new w("panel"),this.styleEle=document.createElement("style"),this.fetchLock=new E,this.appendLock=new E,this.inputs={fillter:document.createElement("input"),page:document.createElement("input"),password:document.createElement("input"),token:document.createElement("input"),refLimit:document.createElement("input"),s:document.createElement("input"),e:document.createElement("input"),img:document.createElement("input")},this.selects={order:document.createElement("select"),colorScheme:document.createElement("select"),refMode:document.createElement("select"),foldText:document.createElement("select"),foldImg:document.createElement("select"),foldComments:document.createElement("select"),fontSize:document.createElement("select")},this.textareas={text:document.createElement("textarea"),view:document.createElement("textarea")},this.checkboxes={add:new u("add"),star:new u("star"),logout:new u("logout"),login:new u("login"),send:new u("send"),refresh:new u("refresh"),settings:new u("settings"),messages:new u("messages"),img:new u("img"),view:new u("view")},this.forms={add:new w("add"),login:new w("login"),settings:new w("settings"),messages:new w("messages"),view:new w("view")},this.buttons={delete:new g("delete")},this.auto=!1,this.star=!1,this.order="id",this.fillter="",this.page=0,this.token="",this.password="",this.colorScheme="auto",this.fontSize="small",this.refMode="direct",this.foldText="false",this.foldImg="false",this.foldComments="true",this.refLimit=3,this.stars=[],this.s=0,this.e=0,this.ids=[],this.keys=[],this.key="",this.end=!1,this.appendedIds=[],this.lastAppend=Date.now(),this.inited=!1,this.errCount=0,this.maxId=-1,this.maxETimestamp=0,this.local=!1,this.scrollSpeed=500,this.appendThreshod=1e3,this.congestionSleep=5e3,this.recaptchaSleep=18e5,this.errLimit=10,this.errSleep=5e3,this.dRegExp=/\.d\d{0,8}/g,this.idsRegExp=/#\d{1,7}-\d{1,7}|#\d{1,4}\*\*\*|#\d{1,5}\*\*|#\d{1,6}\*|#\d{1,7}/g,e.append(this.element),e.append(this.styleEle),this.sideContent.append(this.panel.append(new A(["tools"]).append(this.checkboxes.add).append(this.checkboxes.star).append(this.checkboxes.refresh)).append(this.forms.add.append(this.textareas.text).append(this.checkboxes.img.append(this.inputs.img)).append(new A(["attachment"]).append(this.buttons.delete)).append(this.checkboxes.send)).append(new f("order").append(this.selects.order)).append(new f("fillter").append(this.inputs.fillter)).append(new f("start date").append(this.inputs.s)).append(new f("end date").append(this.inputs.e)).append(new f("page").append(this.inputs.page)).append(this.checkboxes.messages).append(this.forms.messages).append(this.checkboxes.settings).append(this.forms.settings.append(new f("color scheme").append(this.selects.colorScheme)).append(new f("font size").append(this.selects.fontSize)).append(new f("ref mode").append(this.selects.refMode)).append(new f("ref limit").append(this.inputs.refLimit)).append(new f("fold long text").append(this.selects.foldText)).append(new f("fold long image").append(this.selects.foldImg)).append(new f("fold long comments").append(this.selects.foldComments)).append(this.checkboxes.view).append(this.forms.view.append(this.textareas.view)).append(this.checkboxes.logout))),this.main.append(this.flow),this.forms.login.append(new f("token").append(this.inputs.token)).append(new f("password").append(this.inputs.password)).append(this.checkboxes.login),this.styleEle.textContent='@font-face{font-family:"icomoon";src:url("data:font/woff;base64,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") format("woff");}.root {\n    --color-text: black;\n    --color-light: #6a737d;\n    --color-string: darkorange;\n    --color-number: #098658;\n    --color-keyword: #AF00DB;\n    --color-function: #ecad00;\n    --color-variable: deepskyblue;\n    --color-modifier: dodgerblue;\n    --color-class: #267f99;\n    --color-warn: red;\n    --color-comment: limegreen;\n    --color-border: #e1e4e8;\n    --color-bg: white;\n    --color-area: whitesmoke;\n    --color-pre: #f6f8fa;\n    --color-slice: rgba(211, 211, 211, 0.5);\n    --color-selection: rgba(135, 206, 235, 0.5);\n    --color-span: rgba(27, 31, 35, .05);\n    --font: icomoon, "Segoe UI", "Microsoft YaHei", "Hiragino Sans GB", "STHeiti Light", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";\n    --length-width: calc(210mm - .8in);\n    --length-width-side: 21em;\n    --length-tab: 2em;\n    --length-padding: 1em;\n    --length-gap: .5em;\n    --length-padding-span: .3em;\n    --length-space: .25em;\n    --length-padding-circle: .2em;\n    --length-font-title: 1.8em;\n    --length-font-heading: 1.3em;\n    --length-font-span: .85em;\n    --length-font-log: .8em;\n    --length-font-circle: .7em;\n    --number-ratio-line: 1.5;\n    line-height: var(--number-ratio-line);\n    font-family: var(--font);\n    color: var(--color-text);\n    background-color: var(--color-bg) !important;\n    font-size: 16px;\n}\n\n.root[data-font-size=medium] {\n    font-size: 17px\n}\n\n.root[data-font-size=large] {\n    font-size: 18px\n}\n\n@media screen and (max-width:600px) {\n    .root {\n        font-size: 15px\n    }\n\n    .root[data-font-size=medium] {\n        font-size: 16px\n    }\n\n    .root[data-font-size=large] {\n        font-size: 17px\n    }\n}\n\n@media screen and (max-width:500px) {\n    .root {\n        font-size: 14px\n    }\n\n    .root[data-font-size=medium] {\n        font-size: 15px\n    }\n\n    .root[data-font-size=large] {\n        font-size: 16px\n    }\n}\n\n@media screen and (max-width:400px) {\n    .root {\n        font-size: 13px\n    }\n\n    .root[data-font-size=medium] {\n        font-size: 14px\n    }\n\n    .root[data-font-size=large] {\n        font-size: 15px\n    }\n}\n\n::-webkit-scrollbar {\n    background-color: transparent;\n}\n\n::-webkit-scrollbar-corner {\n    background-color: transparent;\n}\n\n::-webkit-scrollbar-thumb {\n    background-color: var(--color-slice);\n}\n\na {\n    color: inherit;\n    text-decoration: none;\n}\n\na[href] {\n    color: var(--color-modifier);\n}\n\na[href]:hover {\n    text-decoration: underline;\n}\n\nbutton,\ninput[type=button],\ninput[type=reset],\ninput[type=submit],\n.button {\n    font: inherit;\n    color: var(--color-text);\n    border-radius: var(--length-padding-span);\n    padding: var(--length-padding-circle) var(--length-padding);\n    background-color: var(--color-slice);\n    border: none;\n    outline: none;\n    text-align: center;\n    cursor: pointer;\n}\n\nbutton:hover,\ninput[type=button]:hover,\ninput[type=reset]:hover,\ninput[type=submit]:hover,\n.button:hover,\nbutton.pushing,\ninput[type=button].pushing,\ninput[type=reset].pushing,\ninput[type=submit].pushing,\n.button.pushing {\n    background-color: var(--color-selection);\n}\n\nimg,\n.img {\n    max-width: 100%;\n    display: block;\n}\n\ninput,\nselect,\ntextarea,\n.input,\n.select,\n.textarea {\n    font: inherit;\n    color: var(--color-text);\n    padding: 0 var(--length-padding-circle);\n    margin: 0;\n    background-color: transparent;\n    border: 1px solid var(--color-border);\n    outline: none;\n    border-radius: var(--length-padding-span);\n    box-sizing: content-box;\n}\n\ninput:focus,\nselect:focus,\ntextarea:focus,\n.input:focus,\n.select:focus,\n.textarea:focus {\n    border-color: var(--color-variable);\n}\n\nselect {\n    appearance: none;\n    -webkit-appearance: none;\n    -moz-appearance: none;\n}\n\ninput[type=number],\ninput[type=date] {\n    appearance: textfield;\n    -webkit-appearance: textfield;\n    -moz-appearance: textfield;\n}\n\ninput[type=date] {\n    height: auto;\n    width: auto;\n    vertical-align: middle;\n    height: 1.5em;\n}\n\ninput[type=number]::-webkit-inner-spin-button,\ninput[type=number]::-webkit-outer-spin-button,\ninput[type=date]::-webkit-calendar-picker-indicator,\ninput[type=date]::-webkit-clear-button { \n    opacity: 0;\n}\n\ninput[type=file]::-webkit-file-upload-button {\n    display: none;\n}\n\noption,\n.option {\n    background-color: var(--color-bg);\n}\n\ntextarea {\n    resize: none;\n    height: 7.5em;\n}\n\n.lr-struct {\n    min-height: 100vh;\n    position: relative;\n    display: flex;\n}\n\n.lr-struct>.main {\n    margin-left: var(--length-width-side);\n    flex-grow: 1;\n    box-sizing: border-box;\n    width: 100%;\n}\n\n.lr-struct>.button {\n    display: none;\n    position: fixed;\n    left: 0;\n    top: 0;\n}\n\n.lr-struct>.side {\n    box-sizing: border-box;\n    position: fixed;\n    left: 0;\n    top: 0;\n    width: var(--length-width-side);\n    max-width: 80%;\n    height: 100vh;\n    background-color: var(--color-pre);\n    border-right: 1px solid var(--color-border);\n}\n\n@media screen and (max-width:960px) {\n    .lr-struct>.side:not(.active) {\n        display: none;\n    }\n\n    .lr-struct>.button {\n        display: block;\n    }\n\n    .lr-struct>.main {\n        margin-left: 0 !important;\n    }\n}\n\n.lr-struct>.side>.cover {\n    display: none;\n}\n\n.lr-struct.sashing>.side>.cover {\n    display: block;\n    position: fixed;\n    width: 100vw;\n    height: 100%;\n    top: 0;\n    left: 0;\n    cursor: ew-resize;\n}\n\n.lr-struct>.side>.sash {\n    height: 100%;\n    width: 10px;\n    position: absolute;\n    top: 0;\n    right: -5px;\n    cursor: ew-resize;\n}\n\n.lr-struct.sashing>.side>.sash {\n    background-color: var(--color-slice);\n}\n\n.lr-struct>.side>.content {\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n}\n\n.lr-struct>.side>.content.vanished {\n    display: none;\n}\n\n.checkbox {\n    display: inline-block;\n    min-width: 1em;\n    color: var(--color-light);\n    cursor: pointer;\n    padding: var(--length-padding-span);\n    border-radius: var(--length-padding-span);\n    line-height: 1;\n    text-align: center;\n}\n\n.checkbox.checked {\n    color: var(--color-variable);\n}\n\n.checkbox:hover,\n.checkbox.checking {\n    background-color: var(--color-slice);\n}\n\n.checkbox.star::after {\n    content: "\\e905";\n}\n\n.checkbox.refresh::after {\n    content: "\\e904";\n}\n\n.checkbox.comment::after {\n    content: "\\e900";\n}\n\n.checkbox.send::after {\n    content: "\\e902  Send";\n}\n\n.checkbox.logout::after {\n    content: "\\e907  Logout";\n}\n\n.checkbox.login::after {\n    content: "\\e908  Login";\n}\n\n.checkbox.add::after {\n    content: "\\e901";\n}\n\n.checkbox.settings::after {\n    content: "\\e906  Settings";\n}\n\n.checkbox.messages::after {\n    content: "\\e909  Messages";\n}\n\n.checkbox.img::after {\n    content: "\\e90a  Add Image";\n}\n\n.checkbox.view::after {\n    content: "\\e90c  View Token";\n}\n\n.button.delete::after {\n    content: "\\e90b";\n}\n\n.button.menu::after {\n    content: "\\e903";\n}\n\n.tools {\n    display: flex;\n    justify-content: space-around;\n    align-items: center;\n}\n\n.form>:not(:first-child) {\n    margin-top: var(--length-gap);\n}\n\n.form,\n.form-line[data-name] {\n    display: flex;\n    flex-direction: column;\n}\n\n.form>*,\n.form-line[data-name]>* {\n    flex-shrink: 0;\n}\n\n.form-line[data-name]::before {\n    display: block;\n    content: attr(data-name);\n    color: var(--color-light);\n    font-size: var(--length-font-log);\n    text-transform: capitalize;\n}\n\n.root[data-fold-text=true] .hole>.text,\n.root[data-fold-img=true] .attachment,\n.panel .attachment,\n.root[data-fold-comments=true] .comments,\n.form.messages {\n    max-height: 30em;\n    overflow-y: auto;\n}\n\n.hide {\n    display: none !important;\n}\n\n.root.star .form-line.order,\n.root.ids .form-line.order,\n.root.weak .form-line.order {\n    display: none !important;\n}\n\n.root.login .view,\n.root.login .messages,\n.root.login .logout {\n    display: none !important;\n}\n\n.root[data-order=id]:not(.star) .start-date,\n.root[data-order=id]:not(.star) .end-date {\n    display: none !important;\n}\n\n.form.add.img>.checkbox.img,\n.form.add:not(.img)>.attachment {\n    display: none !important;\n}\n\n.flow {\n    padding: 0 var(--length-padding);\n    max-width: var(--length-width);\n    margin: 0 auto;\n}\n\n.flow:empty::before {\n    content: "loading...";\n}\n\n.panel {\n    padding: var(--length-padding);\n    overflow: auto;\n}\n\n.hole {\n    background-color: var(--color-pre);\n    padding: var(--length-padding);\n    margin: var(--length-gap) 0;\n    border-radius: var(--length-padding);\n    overflow-x: hidden;\n}\n\n.hole.ref>.index::before {\n    content: "> ";\n}\n\n.hole.new-comment>.index>.id {\n    color: var(--color-variable);\n}\n\n.hole.new-hole>.index>.id {\n    color: var(--color-string);\n}\n\n.hole.updated>.index>.id {\n    text-decoration: underline;\n}\n\n.hole.hidden>.index>.id {\n    text-decoration: line-through;\n}\n\n.hole.refreshing {\n    filter: brightness(.5);\n}\n\n.hole>:empty:not(.checkbox) {\n    display: none !important;\n}\n\n.index {\n    font-size: var(--length-font-log);\n    white-space: pre-wrap;\n    color: var(--color-light);\n    overflow-x: auto;\n}\n\n.text {\n    white-space: pre-wrap;\n    word-break: break-all;\n    overflow-wrap: anywhere;\n    line-break: anywhere;\n    overflow-x: auto;\n}\n\n.audio {\n    display: inline-block;\n    margin: 0 var(--length-gap);\n}\n\n.more {\n    cursor: pointer;\n    text-align: center;\n    color: var(--color-light);\n    padding: var(--length-padding-span);\n}\n\n.hr {\n    height: 1em;\n}\n\n.hr+.hr{\n    height: 0;\n}\n\n.end::before {\n    content: "- end -";\n    display: block;\n    text-align: center;\n    padding: var(--length-gap);\n    margin-bottom: 5em;\n    color: var(--color-light);\n    font-size: var(--length-font-log);\n}\n\n.checkbox.img {\n    position: relative;\n}\n\n.checkbox.img>input {\n    opacity: 0;\n    position: absolute;\n    left: 0;\n    right: 0;\n    top: 0;\n    bottom: 0;\n    box-sizing: border-box;\n    width: 100%;\n    cursor: pointer;\n}\n\n.attachment {\n    position: relative;\n}\n\n.button.delete {\n    position: absolute;\n    right: 0;\n    top: 0;\n}\n\n.form.add>textarea {\n    height: 15em;\n}\n\n.comments>:not(.more) {\n    display: flex;\n}\n\n.comments>:not(.more)>.name {\n    flex-shrink: 0;\n    white-space: pre;\n    font-size: var(--length-font-log);\n}\n\n.comments>:not(.more).focus>.name {\n    color: var(--color-variable);\n}\n\n.comments>:not(.more)>.name:hover,\n.comments>:not(.more)>.name.checking {\n    background-color: var(--color-slice);\n}\n\n@media print {\n    @page {\n        color-adjust: exact;\n        -webkit-print-color-adjust: exact;\n        size: A4 portrait;\n    }\n\n    .lr-struct {\n        min-height: 0;\n    }\n\n    .lr-struct>.main {\n        margin-left: 0 !important;\n    }\n\n    .lr-struct>.side,\n    .lr-struct>.button {\n        display: none;\n    }\n\n    .main>.flow {\n        margin: 0;\n        padding: 0;\n    }\n}.root[data-color-scheme=dark] {\n    --color-text: #cccccc;\n    --color-light: #8f8f8f;\n    --color-string: #df9e61;\n    --color-number: #B5CEA8;\n    --color-keyword: #cc80c6;\n    --color-function: #DCDCAA;\n    --color-variable: #6ec0ec;\n    --color-modifier: #3074ac;\n    --color-class: #4EC9B0;\n    --color-warn: #F44747;\n    --color-comment: #6A9955;\n    --color-border: #2e3133;\n    --color-bg: #131313;\n    --color-area: #161616;\n    --color-pre: #191b1d;\n    --color-slice: rgba(88, 88, 88, 0.5);\n    --color-selection: rgba(95, 144, 163, 0.5);\n    --color-span: rgba(58, 61, 65, 0.5);\n}\n\n.root.dark .dark{\n    filter: brightness(.5);\n}\n\n.root.dark .invert{\n    filter: invert(.9147982) brightness(.8745098);\n}\n\n@media (prefers-color-scheme: dark) {\n    .root:not([data-color-scheme=light]) {\n        --color-text: #cccccc;\n        --color-light: #8f8f8f;\n        --color-string: #df9e61;\n        --color-number: #B5CEA8;\n        --color-keyword: #cc80c6;\n        --color-function: #DCDCAA;\n        --color-variable: #6ec0ec;\n        --color-modifier: #3074ac;\n        --color-class: #4EC9B0;\n        --color-warn: #F44747;\n        --color-comment: #6A9955;\n        --color-border: #2e3133;\n        --color-bg: #131313;\n        --color-area: #161616;\n        --color-pre: #191b1d;\n        --color-slice: rgba(88, 88, 88, 0.5);\n        --color-selection: rgba(95, 144, 163, 0.5);\n        --color-span: rgba(58, 61, 65, 0.5);\n    }\n\n    .root:not([data-color-scheme=light]) .dark{\n        filter: brightness(.5);\n    }\n\n    .root:not([data-color-scheme=light]) .invert{\n        filter: invert(.9147982) brightness(.8745098);\n    }\n}',this.selects.order.innerHTML="<option>id</option><option>active</option><option>hot</option>",this.selects.colorScheme.innerHTML="<option>auto</option><option>dark</option><option>light</option>",this.selects.fontSize.innerHTML="<option>small</option><option>medium</option><option>large</option>",this.selects.refMode.innerHTML="<option>direct</option><option>recur</option>",this.selects.foldText.innerHTML="<option>true</option><option>false</option>",this.selects.foldImg.innerHTML="<option>true</option><option>false</option>",this.selects.foldComments.innerHTML="<option>true</option><option>false</option>",this.inputs.page.type="number",this.inputs.page.min="1",this.inputs.refLimit.type="number",this.inputs.refLimit.min="0",this.inputs.token.type="password",this.inputs.password.type="password",this.inputs.s.type="date",this.inputs.e.type="date",this.inputs.img.type="file",this.inputs.img.accept="image/*",e.classList.add("root"),this.forms.add.classList.add("hide"),this.forms.login.classList.add("hole"),this.forms.messages.classList.add("hide"),this.forms.settings.classList.add("hide"),this.forms.view.classList.add("hide");const t=new URLSearchParams(document.location.search),n=t.get("fillter");"string"==typeof n&&n.length>0&&(this.fillter=decodeURIComponent(n).trim()),t.has("local")&&(this.local=!0);const o=window.localStorage.getItem("ph-token");"string"==typeof o&&32===o.length&&(this.token=o);const a=window.localStorage.getItem("ph-password");"string"==typeof a&&a.length>0&&(this.password=a);const r=window.localStorage.getItem("ph-stars");null!==r&&(this.stars=r.split(",").map((e=>Number(e))));const c=window.localStorage.getItem("ph-color-scheme");"auto"!==c&&"dark"!==c&&"light"!==c||(this.colorScheme=c),this.parent.dataset.colorScheme=this.colorScheme;const h=window.localStorage.getItem("ph-font-size");"small"!==h&&"medium"!==h&&"large"!==h||(this.fontSize=h),this.parent.dataset.fontSize=this.fontSize;const l=window.localStorage.getItem("ph-ref-mode");"direct"!==l&&"recur"!==l||(this.refMode=l);const d=window.localStorage.getItem("ph-ref-limit");if(null!==d){const e=Number(d);e>=0&&(this.refLimit=e)}const m=window.localStorage.getItem("ph-fold-text");"true"!==m&&"false"!==m||(this.foldText=m),this.parent.dataset.foldText=this.foldText;const p=window.localStorage.getItem("ph-fold-img");"true"!==p&&"false"!==p||(this.foldImg=p),this.parent.dataset.foldImg=this.foldImg;const k=window.localStorage.getItem("ph-fold-comments");"true"!==k&&"false"!==k||(this.foldComments=k),this.parent.dataset.foldComments=this.foldComments,this.inputs.fillter.addEventListener("keydown",(async e=>{"Enter"===e.key&&(this.inputs.page.value="1",await this.start())})),this.inputs.page.addEventListener("keydown",(async e=>{"Enter"===e.key&&await this.start()})),this.inputs.s.addEventListener("keydown",(async e=>{"Enter"===e.key&&(this.inputs.page.value="1",await this.start())})),this.inputs.e.addEventListener("keydown",(async e=>{"Enter"===e.key&&(this.inputs.page.value="1",await this.start())})),this.inputs.refLimit.addEventListener("blur",(async e=>{const t=Number(this.inputs.refLimit.value);t>=0&&(this.refLimit=t,window.localStorage.setItem("ph-ref-limit",t.toString()))})),this.selects.refMode.addEventListener("input",(async e=>{const t=this.selects.refMode.value;"direct"!==t&&"recur"!==t||(this.refMode=t,window.localStorage.setItem("ph-ref-mode",t))})),this.selects.colorScheme.addEventListener("input",(e=>{const t=this.selects.colorScheme.value;"auto"!==t&&"dark"!==t&&"light"!==t||(this.colorScheme=t,window.localStorage.setItem("ph-color-scheme",t),this.parent.dataset.colorScheme=t)})),this.selects.fontSize.addEventListener("input",(e=>{const t=this.selects.fontSize.value;"small"!==t&&"medium"!==t&&"large"!==t||(this.fontSize=t,window.localStorage.setItem("ph-font-size",t),this.parent.dataset.fontSize=t)})),this.selects.foldText.addEventListener("input",(async e=>{const t=this.selects.foldText.value;"true"!==t&&"false"!==t||(this.foldText=t,window.localStorage.setItem("ph-fold-text",t),this.parent.dataset.foldText=t)})),this.selects.foldImg.addEventListener("input",(async e=>{const t=this.selects.foldImg.value;"true"!==t&&"false"!==t||(this.foldImg=t,window.localStorage.setItem("ph-fold-img",t),this.parent.dataset.foldImg=t)})),this.selects.foldComments.addEventListener("input",(async e=>{const t=this.selects.foldComments.value;"true"!==t&&"false"!==t||(this.foldComments=t,window.localStorage.setItem("ph-fold-comments",t),this.parent.dataset.foldComments=t)})),this.selects.order.addEventListener("input",(async e=>{this.inputs.page.value="1","hot"===this.selects.order.value&&(this.inputs.fillter.value=".d "+this.inputs.fillter.value),"id"!==this.selects.order.value&&this.checkboxes.star.classList.remove("checked"),await this.start()})),this.checkboxes.star.addEventListener("click",(async e=>{this.inputs.page.value="1",this.checkboxes.star.classList.toggle("checked"),await this.start()})),this.checkboxes.login.addEventListener("click",(async e=>{32===this.inputs.token.value.length?(this.token=this.inputs.token.value,this.password=this.inputs.password.value,window.localStorage.setItem("ph-token",this.token),window.localStorage.setItem("ph-password",this.password),await this.start()):alert("Invalid token.")})),this.checkboxes.logout.addEventListener("click",(async e=>{const{classList:t}=this.checkboxes.logout;t.contains("checking")||(t.add("checking"),await this.clear(),this.inputs.token.value=this.token,this.inputs.password.value=this.password,this.token="",this.password="",this.stars=[],this.maxId=-1,this.maxETimestamp=0,window.localStorage.removeItem("ph-token"),window.localStorage.removeItem("ph-password"),window.localStorage.removeItem("ph-stars"),window.localStorage.removeItem("ph-max-id"),window.localStorage.removeItem("ph-max-etimestamp"),this.inputs.page.value="1",await this.start(),t.remove("checking"))})),this.checkboxes.send.addEventListener("click",(async e=>{const{classList:t}=this.checkboxes.send;if(t.contains("checking"))return;if(0===this.token.length)return;let n="";if(this.forms.add.classList.contains("img")){const e=this.buttons.delete.element.previousElementSibling;if(null!==e&&e instanceof HTMLImageElement){const t=e.src;t.startsWith("data:image/jpeg;base64,")&&(n=t.slice(23))}}const s=this.textareas.text.value;if(0===s.length&&0===n.length)return void alert("Empty.");t.add("checking");const o=await this.fetchLock.get();if(!1===o)return void t.remove("checking");const a=await async function(e,t,n){let s;if(t.length>0)s={text:e,type:"image",data:t,user_token:n};else{if(!(e.length>0))return 500;s={text:e,type:"text",user_token:n}}const o=await i({action:"dopost",user_token:n},s);if(503===o)return 503;if("number"==typeof o)return 500;const{data:a}=o;if("string"!=typeof a&&"number"!=typeof a)return 500;const r=Number(a);return isNaN(r)?500:{id:r}}(s,n,this.token);if(await this.fetchLock.release(o),500===a||503===a)return void t.remove("checking");const{id:r}=a;if(this.textareas.text.value="",this.forms.add.classList.contains("img")){this.forms.add.classList.remove("img");const e=this.buttons.delete.element.previousElementSibling;null!==e&&e.remove()}this.forms.add.classList.add("hide"),this.checkboxes.add.classList.remove("checked"),this.checkboxes.star.classList.remove("checked"),this.selects.order.value="id",this.inputs.fillter.value="",this.inputs.page.value="1",this.stars.push(r),window.localStorage.setItem("ph-stars",this.stars.join(",")),t.remove("checking"),await this.start()})),this.checkboxes.refresh.addEventListener("click",(async e=>{this.inputs.page.value="1",await this.start()})),this.checkboxes.add.addEventListener("click",(async e=>{const{classList:t}=this.checkboxes.add;t.contains("checked")?(this.forms.add.classList.add("hide"),t.remove("checked")):(this.forms.add.classList.remove("hide"),t.add("checked"))})),this.checkboxes.messages.addEventListener("click",(async e=>{const{classList:t}=this.checkboxes.messages;if(t.contains("checked"))this.forms.messages.classList.add("hide"),t.remove("checked");else{if(0===this.token.length)return;t.add("checking"),this.forms.messages.element.innerHTML="",this.forms.messages.classList.remove("hide");const e=await async function(e){const t=await s("https://pkuhelper.pku.edu.cn/api_xmcp/hole/system_msg",{user_token:e,PKUHelperAPI:"3.0",jsapiver:"201027113050-"+2*Math.floor(Date.now()/72e5)});if(503===t)return 503;if("number"==typeof t)return 500;const{status:n,body:i}=t;if(503===n)return 503;if(200!==n)return 500;try{const{result:e}=JSON.parse(i);return Array.isArray(e)?e:500}catch(e){console.log(e)}return 500}(this.token);if("number"==typeof e)return void t.remove("checking");for(let t=0;t<e.length;t++){let{content:n,timestamp:s,title:i}=e[t],o=v(s);"string"==typeof i&&i.length>0&&(o+=` ${i}`),"string"!=typeof n&&(n=""),this.forms.messages.append(new A([]).append(new A(["index"]).setText(o)).append(new A(["text"]).setHTML(b(n))))}0===e.length&&(this.forms.messages.element.innerHTML="empty"),t.add("checked"),t.remove("checking")}})),this.checkboxes.settings.addEventListener("click",(async e=>{const{classList:t}=this.checkboxes.settings;t.contains("checked")?(this.forms.settings.classList.add("hide"),t.remove("checked")):(this.forms.settings.classList.remove("hide"),t.add("checked"))})),this.checkboxes.view.addEventListener("click",(e=>{this.checkboxes.view.classList.toggle("checked"),this.checkboxes.view.classList.contains("checked")?(this.textareas.view.value=this.token,this.forms.view.classList.remove("hide")):(this.textareas.view.value="",this.forms.view.classList.add("hide"))})),this.inputs.img.addEventListener("change",(async e=>{const t=this.inputs.img.files;if(null===t||0===t.length||this.checkboxes.img.classList.contains("checking"))return;this.checkboxes.img.classList.add("checking");const n=await async function(e){const t=document.createElement("img");return t.src=e,await new Promise((e=>{t.addEventListener("load",(n=>{const s=document.createElement("canvas"),i=s.getContext("2d");if(null===i)return;let o=t.width,a=t.height;o>S&&(a=S*a/o,o=S),a>S&&(o=S*o/a,a=S);const r=o*a/5e6;if(r>1){const e=Math.sqrt(r);o/=e,a/=e}s.width=o,s.height=a,i.drawImage(t,0,0,o,a);for(let t=.9;t>0;t-=.1){const n=s.toDataURL("image/jpeg",t);if(n.length<6e5)return void e(n)}e("")})),setTimeout((()=>{e("")}),1e4)}))}(URL.createObjectURL(t[0]));if(this.inputs.img.value="",0===n.length)return void this.checkboxes.img.classList.remove("checking");const s=document.createElement("img");s.classList.add("dark"),s.src=n,this.buttons.delete.before(s),this.forms.add.classList.add("img"),this.checkboxes.img.classList.remove("checking")})),this.buttons.delete.addEventListener("click",(e=>{this.forms.add.classList.remove("img");const t=this.buttons.delete.element.previousElementSibling;null!==t&&t.remove()})),setInterval((async()=>{this.inited&&this.auto&&window.scrollBy({left:0,top:this.scrollSpeed,behavior:"smooth"})}),1e3),setInterval((async()=>{this.inited&&await this.autoAppendHols()}),500)}async getAndRenderComments(s){const{id:r,commentNum:c}=s;if(isNaN(r)||-1===r)return 500;const h=await this.fetchLock.get();if(!1===h)return 500;const l=await async function(s,r,c,h){let l=404;if((s=Number(s))>e&&!n.includes(s)&&(l=await async function(e,t){return await i({action:"getcomment",pid:e.toString(),user_token:t})}(s,c)),404===l){if(0===h.length)return[];l=await a(s,c,h)}else if("number"!=typeof l&&h.length>0){const e=l.data;if(!t.includes(h)&&e.length>0&&403===await async function(e,t,n){return await o(`cs${e}`,{update:"",token:t,password:n})}(s,c,h)&&t.push(h),r>e.length){const t=await a(s,c,h);if("number"!=typeof t){const n=e.map((e=>Number(e.cid))),s=t.data;for(let t=0;t<s.length;t++){const i=s[t],o=Number(i.cid);n.includes(o)||e.push(i)}e.sort(((e,t)=>Number(e.cid)-Number(t.cid)))}}}return 404===l?[]:503===l?503:"number"==typeof l?500:l.data}(r,c,this.token,this.password);if(await this.fetchLock.release(h),503===l||500===l)return l;s.renderComments(l);for(let e=0;e<l.length;e++){const t=l[e],{text:n}=t;if("string"==typeof n&&n.startsWith("[Helper]"))return s.renderComments([t]),423}return l}parseFillter(){this.ids=[],this.keys=[],this.key="";const e=this.fillter.trim();if(0===e.length)return;const t=e.match(this.dRegExp);if(Array.isArray(t)&&t.length>0){let e=t[t.length-1].slice(2),n=e.slice(-2),s=e.slice(-4,-2),i=e.slice(-8,-4);if(i.length<4){const e=new Date;i=e.getFullYear().toString(),0===s.length&&(s=(e.getMonth()+1).toString(),0===n.length&&(n=e.getDate().toString()))}const o=new Date(`${i}/${s}/${n} 00:00:00`).getTime()/1e3;if(!isNaN(o)){const e=o+86400;this.s=o,this.e=e}}const n=e.match(this.idsRegExp);if(Array.isArray(n)&&n.length>0)for(let e=0;e<n.length;e++){const t=n[e].slice(1);if(t.includes("-")){const[e,n]=t.split("-").map((e=>Number(e)));if(isNaN(e)||isNaN(n))continue;if(e<=n)for(let t=e;t<=n;t++)this.ids.push(t);else for(let t=e;t>=n;t--)this.ids.push(t);continue}if(t.endsWith("***")){const e=Number(t.slice(0,-3));if(isNaN(e)||e<=0)continue;const n=1e3*e,s=n+999;for(let e=n;e<=s;e++)this.ids.push(e);continue}if(t.endsWith("**")){const e=Number(t.slice(0,-2));if(isNaN(e)||e<=0)continue;const n=100*e,s=n+99;for(let e=n;e<=s;e++)this.ids.push(e);continue}if(t.endsWith("*")){const e=Number(t.slice(0,-1));if(isNaN(e)||e<=0)continue;const n=10*e,s=n+9;for(let e=n;e<=s;e++)this.ids.push(e);continue}const s=Number(t);isNaN(s)||this.ids.push(s)}this.fillter=e.replace(this.dRegExp," ").trim(),this.key=this.fillter.replace(this.idsRegExp," ").trim(),this.keys=this.key.split(/\s+/)}async basicallyAppendHoles(e){for(let t=0;t<e.length;t++){let n=e[t];const s=Number(n.data.pid);if(this.appendedIds.includes(s))continue;let i;if(this.appendedIds.push(s),n.idOnly){if(void 0===n.comment&&this.password.length>0){const i=await r(s,this.token,this.password);if(403===i)this.password="",window.localStorage.setItem("ph-password",this.password),this.parent.classList.add("weak");else{if(503===i){await this.fetchLock.sleep(this.congestionSleep),this.appendedIds.pop(),t--;continue}if(500===i){if(this.errCount++,this.errCount>this.errLimit)return 500;await this.fetchLock.sleep(this.errSleep),this.appendedIds.pop(),t--;continue}if(404!==i){const{pid:s}=i;e.splice(t+1,0,{data:{pid:s},isRef:n.isRef,idOnly:!0,comment:i})}}}const o=await c(s,this.token,this.password);if(404===o)continue;if(401===o)return 401;if(403===o){this.password="",window.localStorage.setItem("ph-password",this.password),this.parent.classList.add("weak");continue}if(500===o){if(this.errCount++,this.errCount>this.errLimit)return 500;await this.fetchLock.sleep(this.errSleep),this.appendedIds.pop(),t--;continue}if(503===o){await this.fetchLock.sleep(this.congestionSleep),this.appendedIds.pop(),t--;continue}i=o}else i=n.data;const o=new k;let a;if(o.render(i,this.local,n.isRef,this.stars.includes(s),this.maxId,this.maxETimestamp),o.handleStar=async()=>{if(0===this.token.length)return;const{classList:e}=o.checkboxes.star,t=e.contains("checked"),n=await this.fetchLock.get();if(!1===n)return;const i=await l(s,t,this.token);if(await this.fetchLock.release(n),503===i||500===i)return;let a=Number(o.checkboxes.star.element.textContent);if(t){for(let e=0;e<this.stars.length;e++)this.stars[e]===s&&(this.stars[e]=-1);a--}else this.stars.push(s),a++;409!==i&&(o.checkboxes.star.element.textContent=0===a?"":a.toString()+" "),window.localStorage.setItem("ph-stars",this.stars.join(",")),e.toggle("checked")},o.handleRefresh=async()=>{await this.refreshHole(o)},o.handleSend=async()=>{if(0===this.token.length)return;const e=o.textareas.comment.value;if(0===e.length||null!==e.match(o.toNameRegExp))return;const t=await this.fetchLock.get();if(!1===t)return;const n=await d(s,e,this.token);await this.fetchLock.release(t),200===n&&(o.textareas.comment.value="",o.forms.comment.classList.add("hide"),o.checkboxes.comment.classList.remove("checked"),o.reverse=!0,this.stars.push(s),window.localStorage.setItem("ph-stars",this.stars.join(",")),await this.refreshHole(o))},this.flow.append(o.element),n.idOnly&&void 0!==n.comment)a=[n.comment],o.renderComments(a);else for(;;){const e=await this.getAndRenderComments(o);if(500!==e)if(423!==e){if(503!==e){a=e;break}await this.fetchLock.sleep(this.congestionSleep)}else await this.fetchLock.sleep(this.recaptchaSleep);else{if(this.errCount++,this.errCount>this.errLimit)return 500;await this.fetchLock.sleep(this.errSleep)}}if(this.refLimit<=0)continue;let h=i.text;"string"!=typeof h&&(h="");const m=h+"\n"+a.map((e=>{let t=e.text;return"string"!=typeof t&&(t=""),t})).join("\n");if(!n.isRef||"recur"===this.refMode){const n=m.match(/\b\d{6,7}\b|%23\d{3,7}\b/g);if(null!==n){const s=Math.min(n.length,this.refLimit);for(let i=0;i<s;i++){let s=n[i];s.startsWith("%23")&&(s=s.slice(3)),e.splice(t+i+1,0,{data:{pid:s},isRef:!0,idOnly:!0})}}}}return 200}fillterStars(e){const t=[];for(let n=0;n<e.length;n++){const s=e[n],i=Number(s.timestamp);if(i<this.s||this.e>0&&i>this.e)continue;let o=s.text;"string"!=typeof o&&(o="");let a=!0;for(let e=0;e<this.keys.length;e++)if(!o.includes(this.keys[e])){a=!1;break}a&&t.push(s)}return t}async appendHoles(){if(this.end||!this.inited)return;const e=await this.appendLock.get();if(!1===e)return;if(0===this.token.length?(this.flow.element.innerHTML="",this.flow.append(this.forms.login),this.parent.classList.add("login"),this.end=!0):this.parent.classList.remove("login"),this.end)return void await this.appendLock.release(e);let t;if(this.star)for(this.end=!0,this.page=0;;){const e=await h(this.token);if(401===e){t=e;break}if(500!==e){if(503!==e){this.stars=e.map((e=>Number(e.pid))),window.localStorage.setItem("ph-stars",this.stars.join(",")),t=this.fillterStars(e).map((e=>({data:e,isRef:!1,idOnly:!1})));break}await this.fetchLock.sleep(this.congestionSleep)}else{if(this.errCount++,this.errCount>this.errLimit){t=e;break}await this.fetchLock.sleep(this.errSleep)}}else if(this.ids.length>0)t=this.ids.slice(this.page,this.page+1).map((e=>({data:{pid:e},isRef:!1,idOnly:!0}))),this.ids.length===this.page+1&&(this.end=!0);else for(;;){const e=await m(this.key,this.page+1,this.order,this.s,this.e,this.token,this.password);if(401===e){t=e;break}if(403===e){t=e;break}if(500!==e){if(503!==e){t=e.map((e=>({data:e,isRef:!1,idOnly:!1})));break}await this.fetchLock.sleep(this.congestionSleep)}else{if(this.errCount++,this.errCount>this.errLimit){t=e;break}await this.fetchLock.sleep(this.errSleep)}}if(401===t)return alert("Wrong token."),this.flow.element.innerHTML="",this.flow.append(this.forms.login),this.parent.classList.add("login"),this.end=!0,void await this.appendLock.release(e);if(403===t)alert("Permission denied."),this.password="",window.localStorage.setItem("ph-password",this.password),this.end=!0;else if(500===t)this.end=!0;else if(0===t.length)this.end=!0;else{this.page++,this.inputs.page.value=this.page.toString();const n=await this.basicallyAppendHoles(t);if(401===n)return alert("Wrong token."),this.flow.element.innerHTML="",this.flow.append(this.forms.login),this.parent.classList.add("login"),this.end=!0,void await this.appendLock.release(e);500===n&&(this.end=!0)}if(this.end){const e=document.createElement("div");e.classList.add("end"),this.flow.append(e)}else{const e=document.createElement("div");e.classList.add("hr"),this.flow.append(e)}await this.appendLock.release(e)}async autoAppendHols(){Date.now()<this.lastAppend+250||window.pageYOffset+window.innerHeight<document.body.scrollHeight-this.appendThreshod||this.appendLock.busy||(this.lastAppend=Date.now(),await this.appendHoles())}async clear(){if(this.flow.element.innerHTML="",this.parseFillter(),await this.fetchLock.kill(),await this.appendLock.kill(),0===this.password.length?(this.order="id",this.parent.classList.add("weak")):this.parent.classList.remove("weak"),this.ids.length>0?(this.order="id",this.parent.classList.add("ids")):this.parent.classList.remove("ids"),this.star?(this.order="id",this.parent.classList.add("star")):this.parent.classList.remove("star"),this.parent.dataset.order=this.order,"id"!==this.order||this.star||(this.s=0,this.e=0),this.flow.element.innerHTML="",this.selects.order.value=this.order,this.selects.colorScheme.value=this.colorScheme,this.selects.fontSize.value=this.fontSize,this.selects.refMode.value=this.refMode,this.selects.foldText.value=this.foldText,this.selects.foldImg.value=this.foldImg,this.selects.foldComments.value=this.foldComments,this.inputs.fillter.value=this.fillter,this.inputs.page.value=this.page.toString(),this.inputs.refLimit.value=this.refLimit.toString(),0===this.s)this.inputs.s.value="";else{const e=new Date(1e3*this.s);this.inputs.s.value=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}if(0===this.e)this.inputs.e.value="";else{const e=new Date(1e3*this.e-864e5);this.inputs.e.value=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}this.star?this.checkboxes.star.classList.add("checked"):this.checkboxes.star.classList.remove("checked"),this.end=!1,this.appendedIds=[],this.errCount=0;const e=window.localStorage,t=e.getItem("ph-max-id");if(null!==t){const e=Number(t);isNaN(e)||(this.maxId=e)}const n=e.getItem("ph-max-etimestamp");if(null!==n){const e=Number(n);isNaN(e)||(this.maxETimestamp=e)}await this.fetchLock.revive(),await this.appendLock.revive()}async start(){this.fillter=this.inputs.fillter.value.trim();const e=Number(this.inputs.page.value);!isNaN(e)&&e>=1&&e%1==0&&(this.page=e-1);const t=this.selects.order.value;"id"===t?this.order="id":"active"===t?this.order="active":"hot"===t&&(this.order="hot"),this.star=this.checkboxes.star.classList.contains("checked");let n=this.inputs.s.value;this.s=""===n?0:new Date(n+" 00:00:00").getTime()/1e3,n=this.inputs.e.value,this.e=""===n?0:new Date(n+" 00:00:00").getTime()/1e3+86400,await this.clear(),await this.appendHoles()}async init(){await this.clear(),this.inited=!0,await this.appendHoles()}async refreshHole(e){const{id:t}=e;if(isNaN(t)||-1===t)return 500;let n;for(;;){const e=await c(t,this.token,this.password);if(404===e){n=404;break}if(401===e){n=500;break}if(403===e){this.password="",window.localStorage.setItem("ph-password",this.password),this.parent.classList.add("weak"),n=404;break}if(500!==e){if(503!==e){n=e;break}await this.fetchLock.sleep(this.congestionSleep)}else{if(this.errCount++,this.errCount>this.errLimit){n=500;break}await this.fetchLock.sleep(this.errSleep)}}if("number"==typeof n)return n;for(e.render(n,this.local,e.isRef,this.stars.includes(t),this.maxId,this.maxETimestamp);;){const t=await this.getAndRenderComments(e);if(500!==t)if(423!==t){if(503!==t)break;await this.fetchLock.sleep(this.congestionSleep)}else await this.fetchLock.sleep(this.recaptchaSleep);else{if(this.errCount++,this.errCount>this.errLimit)return 500;await this.fetchLock.sleep(this.errSleep)}}return 200}softPause(){this.auto&&(this.auto=!1)}softContinue(){this.auto||(this.auto=!0)}async wake(){0!==this.fetchLock.sleepTime&&await this.fetchLock.wake()}async hardContinue(){this.softContinue(),await this.start()}}(document.body),window.main.init()})();