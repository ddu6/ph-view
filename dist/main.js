(()=>{"use strict";const t=32859,e=[""];async function n(t={},e={}){Object.assign(t,{PKUHelperAPI:"3.0",jsapiver:"201027113050-449842"});const n=await async function(t,e={},n={},s="",i=""){let a=new URL(t).searchParams.toString();a.length>0&&(a+="&"),a+=new URLSearchParams(e).toString(),a.length>0&&(a="?"+a),t=new URL(a,t).href;const o=new URLSearchParams(n).toString(),r={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.198 Safari/537.36"};s.length>0&&(r.Cookie=s),i.length>0&&(r.Referer=i);const h={method:o.length>0?"POST":"GET",headers:r,referrerPolicy:"no-referrer"};return o.length>0&&(Object.assign(r,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}),Object.assign(h,{body:o})),await new Promise((async e=>{setTimeout((()=>{e(500)}),6e4);const n=await fetch(t,h),{headers:s,status:i}=n;if(200===i){try{const t=await n.text();e({status:i,body:t,headers:s})}catch(t){console.log(t)}e(500)}else e(i)}))}("https://pkuhelper.pku.edu.cn/services/pkuhole/api.php",t,e);if("number"==typeof n)return n;const{status:s,body:i}=n;if(200!==s)return s;try{const{code:t,data:e,msg:n}=JSON.parse(i);if(0===t)return{data:e};if("没有这条树洞"===n)return 404;"string"==typeof n&&n.length>0&&console.log(n)}catch(t){console.log(t)}return 500}async function s(t,e={}){return await new Promise((async n=>{let s=new URLSearchParams(e).toString();s.length>0&&(s="?"+s),setTimeout((()=>{n(503)}),6e4);try{const e=await fetch(`https://ddu6.xyz/services/ph-get/${t}${s}`);if(200!==e.status)return void n(500);const{status:i,data:a}=await e.json();if(200===i)return void n({data:a});if("number"==typeof i)return void n(i)}catch(t){console.log(t)}n(500)}))}async function i(t,e,n){return await s(`local/c${t}`,{token:e,password:n})}async function a(i,a,o){let r=404;if(Number(i)>t&&(r=await async function(t,e){return await n({action:"getone",pid:t.toString(),user_token:e})}(i,a)),404===r){if(0===o.length)return 404;r=await async function(t,e,n){return await s(`local/h${t}`,{token:e,password:n})}(i,a,o)}return 401===r?401:503===r?503:404===r?404:"number"==typeof r?500:0===Number(r.data.timestamp)?404:(e.includes(o)||401===await async function(t,e,n){return await s(`h${t}`,{update:"",token:e,password:n})}(i,a,o)&&e.push(o),r.data)}async function o(t){const e=await n({action:"getattention",user_token:t});return 401===e?401:503===e?503:404===e?[]:"number"==typeof e?500:e.data}async function r(e,s,i){if(Number(e)<=t)return 500;const a=await n({action:"attention",pid:e.toString(),switch:s?"0":"1",user_token:i});return"number"!=typeof a?200:503===a?503:404===a?404:500}async function h(e,s,i){if(Number(e)<=t||0===s.length)return 500;const a=await n({action:"docomment",user_token:i},{pid:e.toString(),text:s,user_token:i});return"number"!=typeof a?200:503===a?503:404===a?404:500}async function l(t,i,a,o,r,h,l){if("id"!==a){if(0===l.length)return 401;const e=await async function(t,e,n,i,a,o,r){return await s(`local/p${e}`,{key:t,order:n,s:i.toString(),e:a.toString(),token:o,password:r})}(t,i,a,o,r,h,l);if(401===e)return 401;if(503===e)return 503;if("number"==typeof e)return 500;const n=e.data;if("active"===a&&n.length>0){let{etimestamp:t}=n[0];if("string"==typeof t&&(t=Number(t)),"number"==typeof t){const e=window.localStorage,n=e.getItem("ph-max-etimestamp");null!==n?t>Number(n)&&e.setItem("ph-max-etimestamp",t.toString()):e.setItem("ph-max-etimestamp",t.toString())}}return n}const c=await async function(t,e,s){return 0===t.length?await async function(t,e){return await n({action:"getlist",p:t.toString(),user_token:e})}(e,s):await async function(t,e,s){return await n({action:"search",pagesize:"50",page:e.toString(),keywords:t,user_token:s})}(t,e,s)}(t,i,h);if(401===c)return 401;if(404===c)return[];if(503===c)return 503;if("number"==typeof c)return 500;e.includes(l)||401===await async function(t,e,n,i){return await s(`p${e}`,{update:"",key:t,token:n,password:i})}(t,i,h,l)&&e.push(l);const d=c.data;if(d.length>0){let{pid:t,timestamp:e}=d[0];"string"==typeof t&&(t=Number(t));const n=window.localStorage,s=n.getItem("ph-max-id");null!==s?t>Number(s)&&n.setItem("ph-max-id",t.toString()):n.setItem("ph-max-id",t.toString()),"string"==typeof e&&(e=Number(e));const i=n.getItem("ph-max-etimestamp");null!==i?e>Number(i)&&n.setItem("ph-max-etimestamp",e.toString()):n.setItem("ph-max-etimestamp",e.toString())}return d}class c{constructor(){this.element=document.createElement("div"),this.index=document.createElement("div"),this.content=document.createElement("div"),this.text=document.createElement("div"),this.attachment=document.createElement("div"),this.comments=document.createElement("div"),this.menu=document.createElement("div"),this.replyArea=document.createElement("div"),this.replyCheckbox=document.createElement("div"),this.starCheckbox=document.createElement("div"),this.refreshCheckbox=document.createElement("div"),this.textarea=document.createElement("textarea"),this.sendCheckbox=document.createElement("div"),this.restComments=[],this.commentLimit=50,this.isRef=!1,this.id=-1,this.reverse=!1,this.maxETimestamp=0,this.element.append(this.index),this.element.append(this.content),this.content.append(this.text),this.content.append(this.attachment),this.content.append(this.menu),this.menu.append(this.replyCheckbox),this.menu.append(this.starCheckbox),this.menu.append(this.refreshCheckbox),this.content.append(this.replyArea),this.replyArea.append(this.textarea),this.replyArea.append(this.sendCheckbox),this.content.append(this.comments),this.element.classList.add("hole"),this.index.classList.add("index"),this.content.classList.add("content"),this.text.classList.add("text"),this.attachment.classList.add("attachment"),this.menu.classList.add("menu"),this.replyArea.classList.add("reply-area"),this.replyArea.classList.add("hide"),this.comments.classList.add("comments"),this.replyCheckbox.classList.add("reply"),this.replyCheckbox.classList.add("checkbox"),this.starCheckbox.classList.add("star"),this.starCheckbox.classList.add("checkbox"),this.refreshCheckbox.classList.add("refresh"),this.refreshCheckbox.classList.add("checkbox"),this.sendCheckbox.classList.add("send"),this.sendCheckbox.classList.add("checkbox")}render(t,e,n,s,i,a){this.isRef=n,this.maxETimestamp=a,n?this.element.classList.add("ref"):this.element.classList.remove("ref");let{text:o,tag:r,pid:h,timestamp:l,reply:c,likenum:p,type:u,url:m,etimestamp:g,hidden:f}=t;if(1===Number(f)?this.element.classList.add("hidden"):this.element.classList.remove("hidden"),"string"!=typeof o&&(o=""),"string"!=typeof r&&(r=""),this.id=Number(h),this.index.innerHTML=`<span class="id">${h}</span> ${A(l)}${r.length>0?` <span class="tag">${d(r)}</span>`:""}`,0!==Number(c)&&(this.replyCheckbox.textContent=c.toString()+" "),0!==Number(p)&&(this.starCheckbox.textContent=p.toString()+" "),s?this.starCheckbox.classList.add("checked"):this.starCheckbox.classList.remove("checked"),this.replyCheckbox.onclick=async t=>{const{classList:e}=this.replyCheckbox;e.add("checking"),e.contains("checked")?(this.replyArea.classList.add("hide"),e.remove("checked")):(this.replyArea.classList.remove("hide"),e.add("checked")),e.remove("checking")},this.starCheckbox.onclick=async t=>{const{classList:e}=this.starCheckbox;e.add("checking"),await this.handleStar(),e.remove("checking")},this.refreshCheckbox.onclick=async t=>{const{classList:e}=this.refreshCheckbox,{classList:n}=this.element;this.reverse=!this.reverse,e.add("checking"),n.add("refreshing"),await this.handleRefresh(),n.remove("refreshing"),e.remove("checking")},this.sendCheckbox.onclick=async t=>{const{classList:e}=this.sendCheckbox,{classList:n}=this.element;e.add("checking"),n.add("refreshing"),await this.handleSend(),n.remove("refreshing"),e.remove("checking")},this.text.innerHTML=d(o),this.attachment.innerHTML="","string"==typeof m&&m.length>0)if("image"===u){const t=document.createElement("img");t.src=`https://${e?"ddu6.xyz/ph/imgs":"pkuhelper.pku.edu.cn/services/pkuhole/images"}/${m}`,this.attachment.append(t)}else if("audio"===u){const t=document.createElement("a");t.classList.add("audio"),t.href=`https://${e?"ddu6.xyz/ph/audios":"pkuhelper.pku.edu.cn/services/pkuhole/audios"}/${m}`,t.textContent="Audio",t.target="_blank",this.text.append(t)}"string"==typeof h&&(h=Number(h)),h>i&&this.element.classList.add("new-hole"),"string"==typeof g&&(g=Number(g)),"number"==typeof g&&g>a&&this.element.classList.add("new-comment")}appendComment(t){let{text:e,tag:n,timestamp:s}=t;"string"!=typeof e&&(e=""),"string"!=typeof n&&(n="");const i=e.indexOf("] "),a=e.slice(1,i);e=e.slice(i+2);const o=document.createElement("div"),r=document.createElement("div"),h=document.createElement("div");o.append(r),o.append(h),o.classList.add("comment"),r.classList.add("index"),h.classList.add("content"),h.classList.add("text"),r.textContent=`${a} ${A(s)}${n.length>0?` <span class="tag">${d(n)}</span>`:""}`,h.innerHTML=d(e),this.comments.append(o),"string"==typeof s&&(s=Number(s)),"number"==typeof s&&s>this.maxETimestamp&&this.element.classList.add("new-comment")}addMoreButton(t){const e=document.createElement("div");this.comments.append(e),e.textContent=`${t} more`,e.classList.add("more"),e.addEventListener("click",(t=>{e.remove(),this.renderRestComments()}))}renderComments(t){if(this.comments.innerHTML="",this.restComments=[],t.length>=2&&(Number(t[0].cid)>Number(t[1].cid)?this.reverse||t.reverse():this.reverse&&t.reverse()),t.length<2*this.commentLimit)for(let e=0;e<t.length;e++)this.appendComment(t[e]);else{for(let e=0;e<this.commentLimit;e++)this.appendComment(t[e]);this.restComments=t.slice(this.commentLimit),this.addMoreButton(this.restComments.length)}}renderRestComments(){if(this.restComments.length<20*this.commentLimit){for(let t=0;t<this.restComments.length;t++)this.appendComment(this.restComments[t]);return void(this.restComments=[])}const t=this.restComments.slice(0,10*this.commentLimit);this.restComments=this.restComments.slice(10*this.commentLimit);for(let e=0;e<t.length;e++)this.appendComment(t[e]);this.addMoreButton(this.restComments.length)}async handleStar(){}async handleRefresh(){}async handleSend(){}}function d(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\'/g,"&#39;").replace(/\"/g,"&quot;").replace(/(^|[^.@a-z0-9_])((?:https?:\/\/)(?:(?:[\w-]+\.)+[a-z]{2,5}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d{1,5})?(?:\/[\w~!@#$%^&*\-_=+[\]{};:,./?|]*)?)(?![.@a-z0-9_])(?=[^<>]*(<[^\/]|$))/gi,'$1<a href="$2" target="_blank">$2</a>').replace(/(^|[^.@a-z0-9_\/])((?:(?:[\w-]+\.)+[a-z]{2,5}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d{1,5})?(?:\/[\w~!@#$%^&*\-_=+[\]{};:,./?|]*)?)(?![.@a-z0-9_])(?=[^<>]*(<[^\/]|$))/gi,'$1<a href="https://$2" target="_blank">$2</a>').replace(/(\b\d{5,7}\b)(?=[^<>]*(<[^\/]|$))/g,`<a href="${document.location.origin+document.location.pathname}?fillter=%23$1" target="_blank">$1</a>`)}function A(t){const e=new Date(Number(t+"000")),n=new Date,s=e.getFullYear(),i=n.getFullYear(),a=e.getMonth()+1+"/"+e.getDate(),o=n.getMonth()+1+"/"+n.getDate(),r=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds();return s!==i?r+" "+s+"/"+a:o!==a?r+" "+a:r}class p{constructor(t){if(this.e=t,t.targetTouches.length>0){let e=0,n=t.targetTouches[0];for(let s=0;s<t.targetTouches.length;s++){const i=t.targetTouches[s];i.force>e&&(n=i,e=n.force)}this.targetTouch=n}}}class u{constructor(){this.queue=[]}async get(t=1e4){return await new Promise((e=>{const n=Symbol(),s={symbol:n,listen:()=>{e(n)},failed:!1};t>0&&setTimeout((()=>{e(!1),s.failed=!0}),t),this.queue.push(s),this.queue[0].symbol===n&&e(n)}))}release(t){if(0!==this.queue.length&&this.queue[0].symbol===t){for(this.queue.shift();this.queue.length>0&&this.queue[0].failed;)this.queue.shift();this.queue.length>0&&this.queue[0].listen()}}}class m{constructor(){this.busy=!1,this.sleepTime=0,this.lock=new u,this.killLock=new u,this.killing=!1,this.killed=!1,this.killedListen=()=>{},this.killingListen=async t=>{},this.queue=[]}async get(t=1e4){return await new Promise((async e=>{const n=Symbol(),s={symbol:n,listen:t=>{t?e(!1):(e(n),this.busy=!0)},failed:!1};t>0&&setTimeout((()=>{e(!1),s.failed=!0}),t);const i=await this.lock.get(-1);if(this.killing||this.killed)return e(!1),void this.lock.release(i);this.queue.push(s),this.queue[0].symbol===n&&(e(n),this.busy=!0),this.lock.release(i)}))}async release(t){const e=await this.lock.get(-1);if(0!==this.queue.length&&this.queue[0].symbol===t){for(this.queue.shift();this.queue.length>0&&this.queue[0].failed;)this.queue.shift();if(this.busy=!1,this.killing||this.killed){for(let t=0;t<this.queue.length;t++)this.queue[t].listen(!0);this.queue=[],this.killedListen()}else this.queue.length>0&&this.queue[0].listen(!1);this.lock.release(e)}else this.lock.release(e)}async kill(t=1e4){const e=await this.killLock.get(-1),n=await new Promise((async e=>{const n=await this.lock.get(-1);this.killing=!0,this.killedListen=()=>{e(!0)};const s=this.queue.length;if(0===s)return this.lock.release(n),void e(!0);t>0&&setTimeout((()=>{e(!1)}),t);const{symbol:i}=this.queue[s-1],a=this.killingListen;this.lock.release(n),await a(i)})),s=await this.lock.get(-1);return this.killed=!0,this.killing=!1,this.lock.release(s),this.killLock.release(e),n}async revive(){const t=await this.killLock.get(-1),e=await this.lock.get(-1);if(!1===this.killed)return this.lock.release(e),void this.killLock.release(t);this.killed=!1,this.queue=[],this.killing=!1,this.busy=!1,this.sleepTime=0,this.lock.release(e),this.killLock.release(t)}async setKillingListen(t,e=(async()=>{})){const n=await this.lock.get(-1);if(0===this.queue.length||this.queue[0].symbol!==t||this.killed)this.lock.release(n);else{if(this.killing)return this.lock.release(n),void await e();this.killingListen=async n=>{t===n&&await e()},this.lock.release(n)}}async sleep(t){await new Promise((async e=>{const n=await this.get(t);!1!==n?(this.sleepTime=t,await this.setKillingListen(n,(async()=>{this.sleepTime=0,await this.release(n),e(!0)})),setTimeout((async()=>{this.sleepTime=0,await this.release(n),e(!0)}),t)):e(!0)}))}async wake(){const t=await this.lock.get(-1),e=this.queue.length;if(this.killing||this.killed||!this.busy||0===this.sleepTime||0===e)return void this.lock.release(t);const{symbol:n}=this.queue[e-1];this.lock.release(t),await this.killingListen(n)}}document.head.innerHTML="<meta charset='utf8'>\n<meta name='viewport' content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=0'>\n<title>PKU Hole</title>\n<link rel=\"icon\" href=\"https://cdn.jsdelivr.net/gh/ddu6/static@0.1.0/imgs/ph.png\" type=\"image/png\">",document.body.style.margin="0",window.main=new class extends class{constructor(){this.element=document.createElement("div"),this.side=document.createElement("div"),this.button=document.createElement("div"),this.sideContent=document.createElement("div"),this.main=document.createElement("div"),this.sash=document.createElement("div"),this.cover=document.createElement("div"),this.sashing=!1,this.sashX=0,this.side.append(this.sideContent),this.side.append(this.cover),this.side.append(this.sash),this.element.append(this.main),this.element.append(this.button),this.element.append(this.side),this.element.classList.add("lr-struct"),this.main.classList.add("main"),this.button.classList.add("button"),this.side.classList.add("side"),this.sideContent.classList.add("content"),this.sash.classList.add("sash"),this.cover.classList.add("cover"),this.sideWidth=this.side.offsetWidth,this.button.addEventListener("mousedown",(t=>{t.preventDefault(),this.side.classList.add("active")})),this.main.addEventListener("mousedown",(t=>{this.side.classList.remove("active")})),this.sash.addEventListener("mousedown",(t=>{t.preventDefault(),this.sashing=!0,this.sashX=t.clientX,this.sideWidth=this.side.offsetWidth,this.element.classList.add("sashing")})),this.sash.addEventListener("touchstart",(t=>{this.sashing=!0;const e=new p(t).targetTouch;void 0!==e&&(this.sashX=e.clientX,this.sideWidth=this.side.offsetWidth,this.element.classList.add("sashing"))})),document.addEventListener("mousemove",(t=>{if(!this.sashing)return;t.preventDefault();const e=t.clientX-this.sashX,n=Math.min(Math.max(this.sideWidth+e,30),this.element.offsetWidth);this.side.style.width=n+"px",this.main.style.marginLeft=this.side.offsetWidth+"px",this.side.offsetWidth<=50?this.sideContent.classList.add("vanished"):this.sideContent.classList.remove("vanished")})),this.sash.addEventListener("touchmove",(t=>{if(t.cancelable&&t.preventDefault(),!this.sashing)return;const e=new p(t).targetTouch;if(void 0===e)return;const n=e.clientX-this.sashX,s=Math.min(Math.max(this.sideWidth+n,30),this.element.offsetWidth);this.side.style.width=s+"px",this.main.style.marginLeft=this.side.offsetWidth+"px",this.side.offsetWidth<=50?this.sideContent.classList.add("vanished"):this.sideContent.classList.remove("vanished")})),document.addEventListener("mouseup",(async t=>{!0===this.sashing&&(this.sashing=!1,this.element.classList.remove("sashing"),await this.handleSash())})),document.addEventListener("touchend",(async t=>{!0===this.sashing&&(this.sashing=!1,this.element.classList.remove("sashing"),await this.handleSash())}))}async handleSash(){}}{constructor(t){super(),this.parent=t,this.panel=document.createElement("div"),this.orderSelect=document.createElement("select"),this.fillterInput=document.createElement("input"),this.pageInput=document.createElement("input"),this.menu=document.createElement("div"),this.starCheckbox=document.createElement("div"),this.autoCheckbox=document.createElement("div"),this.logoutCheckbox=document.createElement("div"),this.loginForm=document.createElement("div"),this.tokenInput=document.createElement("input"),this.passwordInput=document.createElement("input"),this.tokenLine=document.createElement("div"),this.passwordLine=document.createElement("div"),this.loginCheckbox=document.createElement("div"),this.flow=document.createElement("div"),this.style=document.createElement("style"),this.globalStyle=document.createElement("style"),this.fetchLock=new m,this.appendLock=new m,this.auto=!1,this.star=!1,this.order="id",this.fillter="",this.page=0,this.token="",this.password="",this.stars=[],this.s=0,this.e=0,this.ids=[],this.keys=[],this.key="",this.end=!1,this.appendedIds=[],this.lastAppend=Date.now(),this.inited=!1,this.errCount=0,this.maxId=-1,this.maxETimestamp=0,this.local=!1,this.refMode="direct",this.refLimit=3,this.scrollSpeed=500,this.appendThreshod=1e3,this.congestionSleep=5e3,this.recaptchaSleep=18e5,this.errLimit=10,this.errSleep=5e3,this.dRegExp=/\.d\d{0,8}/g,this.idsRegExp=/#\d{1,7}-\d{1,7}|#\d{1,4}\*\*\*|#\d{1,5}\*\*|#\d{1,6}\*|#\d{1,7}/g,this.shadow=t.attachShadow({mode:"closed"}),this.shadow.append(this.element),this.element.append(this.style),t.append(this.globalStyle),this.sideContent.append(this.panel),this.main.append(this.flow),this.panel.append(this.menu),this.menu.append(this.autoCheckbox),this.menu.append(this.starCheckbox),this.menu.append(this.logoutCheckbox),this.panel.append(this.orderSelect),this.panel.append(this.fillterInput),this.panel.append(this.pageInput),this.loginForm.append(this.tokenLine),this.tokenLine.append(this.tokenInput),this.loginForm.append(this.passwordLine),this.passwordLine.append(this.passwordInput),this.loginForm.append(this.loginCheckbox),this.tokenInput.type="password",this.passwordInput.type="password",t.classList.add("root"),this.panel.classList.add("panel"),this.flow.classList.add("flow"),this.orderSelect.classList.add("order"),this.fillterInput.classList.add("fillter"),this.pageInput.classList.add("page"),this.menu.classList.add("menu"),this.starCheckbox.classList.add("star"),this.autoCheckbox.classList.add("auto"),this.starCheckbox.classList.add("checkbox"),this.autoCheckbox.classList.add("checkbox"),this.logoutCheckbox.classList.add("logout"),this.logoutCheckbox.classList.add("checkbox"),this.loginForm.classList.add("login-form"),this.loginForm.classList.add("hole"),this.tokenInput.classList.add("token"),this.passwordInput.classList.add("password"),this.tokenLine.classList.add("token-line"),this.passwordLine.classList.add("password-line"),this.loginCheckbox.classList.add("login"),this.loginCheckbox.classList.add("checkbox"),this.orderSelect.innerHTML="<option>id</option><option>active</option><option>hot</option>",this.pageInput.type="number",this.pageInput.min="1",this.style.textContent='.root {\n    --color-text: #cccccc;\n    --color-light: #8f8f8f;\n    --color-string: #df9e61;\n    --color-number: #B5CEA8;\n    --color-keyword: #cc80c6;\n    --color-function: #DCDCAA;\n    --color-variable: #6ec0ec;\n    --color-modifier: #3074ac;\n    --color-class: #4EC9B0;\n    --color-warn: #F44747;\n    --color-comment: #6A9955;\n    --color-border: #2e3133;\n    --color-bg: #131313;\n    --color-area: #161616;\n    --color-pre: #191b1d;\n    --color-slice: rgba(88, 88, 88, 0.5);\n    --color-selection: rgba(95, 144, 163, 0.5);\n    --color-span: rgba(58, 61, 65, 0.5);\n    --font: icomoon, "Segoe UI", "Microsoft YaHei", "Hiragino Sans GB", "STHeiti Light", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";\n    --length-width: calc(210mm - .8in);\n    --length-width-side: 280px;\n    --length-width-bar: 15px;\n    --length-tab: 2em;\n    --length-padding: 1em;\n    --length-gap: .5em;\n    --length-padding-span: .3em;\n    --length-space: .25em;\n    --length-padding-circle: .2em;\n    --length-font-title: 1.8em;\n    --length-font-heading: 1.3em;\n    --length-font-span: .85em;\n    --length-font-log: .8em;\n    --length-font-circle: .7em;\n    --number-ratio-line: 1.5;\n    line-height: var(--number-ratio-line);\n    font-family: var(--font);\n    color: var(--color-text);\n    background-color: var(--color-bg) !important;\n    font-size: 16px;\n}\n\n::-webkit-scrollbar {\n    background-color: transparent;\n}\n\n::-webkit-scrollbar-corner {\n    background-color: transparent;\n}\n\n::-webkit-scrollbar-thumb {\n    background-color: var(--color-slice);\n}\n\na {\n    color: inherit;\n    text-decoration: none;\n}\n\na[href] {\n    color: var(--color-modifier);\n}\n\na[href]:hover {\n    text-decoration: underline;\n}\n\nbutton,\ninput[type="button"],\ninput[type="reset"],\ninput[type="submit"],\n.button {\n    font: inherit;\n    color: var(--color-text);\n    border-radius: var(--length-padding-span);\n    padding: var(--length-padding-circle) var(--length-padding);\n    background-color: var(--color-slice);\n    border: none;\n    outline: none;\n    text-align: center;\n}\n\nbutton:hover,\ninput[type="button"]:hover,\ninput[type="reset"]:hover,\ninput[type="submit"]:hover,\n.button:hover,\nbutton.pushing,\ninput[type="button"].pushing,\ninput[type="reset"].pushing,\ninput[type="submit"].pushing,\n.button.pushing {\n    background-color: var(--color-selection);\n}\n\nimg {\n    max-width: 100%;\n    max-height: 280vh;\n    filter: grayscale(50%) brightness(50%);\n    display: block;\n}\n\ninput,\nselect,\ntextarea,\n.input,\n.select,\n.textarea {\n    font: inherit;\n    color: var(--color-text);\n    padding: 0 var(--length-padding-circle);\n    margin: 0;\n    background-color: transparent;\n    border: 1px solid var(--color-border);\n    outline: none;\n    border-radius: var(--length-padding-span);\n    box-sizing: content-box;\n}\n\ninput:focus,\nselect:focus,\ntextarea:focus,\n.input:focus,\n.select:focus,\n.textarea:focus {\n    border-color: var(--color-variable);\n}\n\nselect,\n.select {\n    padding: 0;\n    height: 1.5em;\n}\n\ntextarea {\n    resize: none;\n    height: 7.5em;\n}\n\n.lr-struct {\n    min-height: 100vh;\n    position: relative;\n    display: flex;\n}\n\n.lr-struct>.main {\n    margin-left: var(--length-width-side);\n    flex-grow: 1;\n}\n\n.lr-struct>.button {\n    display: none;\n    position: fixed;\n    left: 0;\n    top: 0;\n}\n\n.lr-struct>.button::after {\n    content: "≡";\n}\n\n.lr-struct>.side {\n    box-sizing: border-box;\n    position: fixed;\n    left: 0;\n    top: 0;\n    width: var(--length-width-side);\n    max-width: 60%;\n    height: 100vh;\n    background-color: var(--color-pre);\n    border-right: 1px solid var(--color-border);\n}\n\n@media screen and (max-width:960px) {\n    .lr-struct>.side:not(.active) {\n        display: none;\n    }\n\n    .lr-struct>.button {\n        display: block;\n    }\n\n    .lr-struct>.main {\n        margin-left: 0 !important;\n    }\n}\n\n.lr-struct>.side>.cover {\n    display: none;\n}\n\n.lr-struct.sashing>.side>.cover {\n    display: block;\n    position: fixed;\n    width: 100vw;\n    height: 100%;\n    top: 0;\n    left: 0;\n    cursor: ew-resize;\n}\n\n.lr-struct>.side>.sash {\n    height: 100%;\n    width: 10px;\n    position: absolute;\n    top: 0;\n    right: -5px;\n    cursor: ew-resize;\n}\n\n.lr-struct.sashing>.side>.sash {\n    background-color: var(--color-slice);\n}\n\n.lr-struct>.side>.content {\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n}\n\n.lr-struct>.side>.content.vanished {\n    display: none;\n}\n\n.checkbox {\n    color: var(--color-light);\n    cursor: pointer;\n    padding: var(--length-padding-span);\n    border-radius: var(--length-padding-span);\n    line-height: 1;\n    text-align: center;\n}\n\n.checkbox.checked {\n    color: var(--color-variable);\n}\n\n.checkbox.checking {\n    background-color: var(--color-slice);\n}\n\n.flow {\n    padding: 0 var(--length-tab);\n    max-width: var(--length-width);\n    margin: 0 auto;\n}\n\n.flow:empty::before {\n    content: "loading...";\n}\n\n.hole {\n    background-color: var(--color-pre);\n    padding: var(--length-padding);\n    margin: var(--length-gap) 0;\n    border-radius: var(--length-padding);\n}\n\n.hole.ref>.index::before {\n    content: "> ";\n}\n\n.hole.new-comment>.index>.id {\n    color: var(--color-variable);\n}\n\n.hole.new-hole>.index>.id {\n    color: var(--color-string);\n}\n\n.hole.updated>.index>.id {\n    text-decoration: underline;\n}\n\n.hole.hidden>.index>.id {\n    text-decoration: line-through;\n}\n\n.hole.refreshing {\n    filter: brightness(.5);\n}\n\n.index {\n    font-size: var(--length-font-log);\n    white-space: pre;\n    color: var(--color-light);\n    overflow-x: auto;\n}\n\n.hole>.index {\n    margin-bottom: var(--length-gap);\n}\n\n.index>.tag {\n    white-space: pre-wrap;\n}\n\n.content {\n    overflow-x: hidden;\n}\n\n.text {\n    white-space: pre-wrap;\n    word-break: break-all;\n    overflow-wrap: anywhere;\n    line-break: anywhere;\n    overflow-x: auto;\n}\n\n.text:not(:empty)+.attachment:not(:empty) {\n    margin-top: var(--length-gap);\n}\n\n.audio {\n    display: inline-block;\n    margin: 0 var(--length-gap);\n}\n\n.comments {\n    max-height: 30em;\n    overflow-y: auto;\n    background-color: var(--color-pre);\n}\n\n.comments:not(:empty) {\n    margin-top: var(--length-gap);\n}\n\n.comments>:not(:first-child) {\n    margin-top: var(--length-gap);\n}\n\n.more {\n    cursor: pointer;\n    text-align: center;\n    font-size: var(--length-font-log);\n    color: var(--color-light);\n}\n\n.hr {\n    height: 1em;\n}\n\n.hr+.hr{\n    height: 0;\n}\n\n.end::before {\n    content: "- end -";\n    display: block;\n    text-align: center;\n    padding: var(--length-gap);\n    margin-bottom: 5em;\n    color: var(--color-light);\n    font-size: var(--length-font-log);\n}\n\n.panel {\n    padding: var(--length-padding);\n    display: flex;\n    flex-direction: column;\n    text-align: center;\n}\n\n.panel>* {\n    margin-bottom: var(--length-gap);\n}\n\n.menu {\n    display: flex;\n    justify-content: space-around;\n    align-items: center;\n}\n\n.hole .menu {\n    margin-top: var(--length-gap);\n    font-size: var(--length-font-log);\n}\n\n.star::after {\n    content: "\\e9d7";\n}\n\n.refresh::after {\n    content: "\\e984";\n    font-size: .8em;\n}\n\n.auto::after {\n    content: "\\ea1c";\n}\n\n.reply::after {\n    content: "\\e900";\n}\n\n.send::after {\n    content: "\\e901";\n}\n\n.logout::after {\n    content: "\\e902";\n}\n\n.login::after {\n    content: "\\e903";\n}\n\n.reply-area {\n    margin-top: var(--length-gap);\n    display: flex;\n    flex-direction: column;\n}\n\n.send {\n    margin-top: var(--length-gap);\n    font-size: var(--length-font-log);\n}\n\n.token-line,.password-line {\n    display: flex;\n    flex-direction: column;\n}\n\n.login-form>:not(:first-child) {\n    margin-top: var(--length-gap);\n}\n\n.token-line::before {\n    display: block;\n    content: "Token";\n    color: var(--color-light);\n    font-size: var(--length-font-log);\n}\n\n.password-line::before {\n    display: block;\n    content: "Password";\n    color: var(--color-light);\n    font-size: var(--length-font-log);\n}\n\n.reply-area.hide,.order.hide {\n    display: none;\n}',this.globalStyle.textContent='@font-face{font-family:"icomoon";src:url("data:font/woff;base64,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") format("woff");}.root {\n    --color-text: #cccccc;\n    --color-light: #8f8f8f;\n    --color-string: #df9e61;\n    --color-number: #B5CEA8;\n    --color-keyword: #cc80c6;\n    --color-function: #DCDCAA;\n    --color-variable: #6ec0ec;\n    --color-modifier: #3074ac;\n    --color-class: #4EC9B0;\n    --color-warn: #F44747;\n    --color-comment: #6A9955;\n    --color-border: #2e3133;\n    --color-bg: #131313;\n    --color-area: #161616;\n    --color-pre: #191b1d;\n    --color-slice: rgba(88, 88, 88, 0.5);\n    --color-selection: rgba(95, 144, 163, 0.5);\n    --color-span: rgba(58, 61, 65, 0.5);\n    --font: icomoon, "Segoe UI", "Microsoft YaHei", "Hiragino Sans GB", "STHeiti Light", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";\n    --length-width: calc(210mm - .8in);\n    --length-width-side: 280px;\n    --length-width-bar: 15px;\n    --length-tab: 2em;\n    --length-padding: 1em;\n    --length-gap: .5em;\n    --length-padding-span: .3em;\n    --length-space: .25em;\n    --length-padding-circle: .2em;\n    --length-font-title: 1.8em;\n    --length-font-heading: 1.3em;\n    --length-font-span: .85em;\n    --length-font-log: .8em;\n    --length-font-circle: .7em;\n    --number-ratio-line: 1.5;\n    line-height: var(--number-ratio-line);\n    font-family: var(--font);\n    color: var(--color-text);\n    background-color: var(--color-bg) !important;\n    font-size: 16px;\n}\n\n@media screen and (max-width:650px) {\n    .root {\n        font-size: 15.5px\n    }\n}\n\n@media screen and (max-width:600px) {\n    .root {\n        font-size: 15px\n    }\n}\n\n@media screen and (max-width:550px) {\n    .root {\n        font-size: 14.5px\n    }\n}\n\n@media screen and (max-width:500px) {\n    .root {\n        font-size: 14px\n    }\n}\n\n@media screen and (max-width:450px) {\n    .root {\n        font-size: 13.5px\n    }\n}\n\n@media screen and (max-width:400px) {\n    .root {\n        font-size: 13px\n    }\n}\n\n::-webkit-scrollbar {\n    background-color: transparent;\n}\n\n::-webkit-scrollbar-corner {\n    background-color: transparent;\n}\n\n::-webkit-scrollbar-thumb {\n    background-color: var(--color-slice);\n}',this.fillterInput.addEventListener("keydown",(async t=>{"Enter"===t.key&&(this.pageInput.value="1",await this.start())})),this.pageInput.addEventListener("keydown",(async t=>{"Enter"===t.key&&await this.start()})),this.orderSelect.addEventListener("input",(async t=>{this.pageInput.value="1","hot"===this.orderSelect.value?this.fillterInput.value.startsWith(".d")||(this.fillterInput.value=".d "+this.fillterInput.value):this.fillterInput.value.startsWith(".d")&&(this.fillterInput.value=this.fillterInput.value.replace(/^\.d\d*\s*/,"")),"id"!==this.orderSelect.value&&this.starCheckbox.classList.remove("checked"),await this.start()})),this.starCheckbox.addEventListener("click",(async t=>{this.pageInput.value="1",this.fillterInput.value.startsWith(".d")&&(this.fillterInput.value=this.fillterInput.value.replace(/^\.d\d*\s*/,"")),this.starCheckbox.classList.toggle("checked"),await this.start()})),this.autoCheckbox.addEventListener("click",(async t=>{this.autoCheckbox.classList.toggle("checked"),this.auto=this.autoCheckbox.classList.contains("checked")})),this.loginCheckbox.addEventListener("click",(async t=>{32===this.tokenInput.value.length?(this.token=this.tokenInput.value,this.password=this.passwordInput.value,window.localStorage.setItem("ph-token",this.token),window.localStorage.setItem("ph-password",this.password),await this.start()):alert("Invalid token.")})),this.logoutCheckbox.addEventListener("click",(async t=>{this.logoutCheckbox.classList.add("checking"),await this.clear(),this.tokenInput.value=this.token,this.passwordInput.value=this.password,this.token="",this.password="",this.stars=[],this.maxId=-1,this.maxETimestamp=0,window.localStorage.setItem("ph-token",this.token),window.localStorage.setItem("ph-password",this.password),window.localStorage.setItem("ph-stars",this.stars.join(",")),window.localStorage.setItem("ph-max-id",this.maxId.toString()),window.localStorage.setItem("ph-max-etimestamp",this.maxETimestamp.toString()),await this.start(),this.logoutCheckbox.classList.remove("checking")})),setInterval((async()=>{this.inited&&this.auto&&window.scrollBy({left:0,top:this.scrollSpeed,behavior:"smooth"})}),1e3),setInterval((async()=>{this.inited&&await this.autoAppend()}),500)}async getAndRenderComments(a,o){const r=await this.fetchLock.get();if(!1===r)return 500;const h=await async function(a,o,r){let h=404;if(Number(a)>t&&(h=await async function(t,e){return await n({action:"getcomment",pid:t.toString(),user_token:e})}(a,o)),404===h){if(0===r.length)return[];await i(a,o,r)}else if("number"!=typeof h&&r.length>0){const t=await i(a,o,r);if("number"!=typeof t){const e=h.data,n=e.map((t=>Number(t.cid))),s=t.data;for(let t=0;t<s.length;t++){const i=s[t],a=Number(i.cid);n.includes(a)||(n.push(a),e.push(i))}e.sort(((t,e)=>Number(t.cid)-Number(e.cid)))}}return 404===h?[]:503===h?503:"number"==typeof h?500:(e.includes(r)||401===await async function(t,e,n){return await s(`c${t}`,{update:"",token:e,password:n})}(a,o,r)&&e.push(r),h.data)}(a,this.token,this.password);if(503===h||500===h)return await this.fetchLock.release(r),h;o.renderComments(h);for(let t=0;t<h.length;t++){const e=h[t],{text:n}=e;if("string"==typeof n&&n.startsWith("[Helper]"))return o.renderComments([e]),await this.fetchLock.release(r),423}return await this.fetchLock.release(r),h}parseFillter(){this.s=0,this.e=0,this.ids=[],this.keys=[],this.key="";let t=this.fillter.trim();if(0===t.length)return;const e=t.match(this.dRegExp);if(Array.isArray(e)&&e.length>0){let t=e[e.length-1].slice(2),n=t.slice(-2),s=t.slice(-4,-2),i=t.slice(-8,-4);if(i.length<4){const t=new Date;i=t.getFullYear().toString(),0===s.length&&(s=(t.getMonth()+1).toString(),0===n.length&&(n=t.getDate().toString()))}const a=new Date(`${i}/${s}/${n}`).getTime()/1e3;if(!isNaN(a)){const t=a+86400;this.s=a,this.e=t}}const n=t.match(this.idsRegExp);if(Array.isArray(n)&&n.length>0)for(let t=0;t<n.length;t++){const e=n[t].slice(1);if(e.includes("-")){const[t,n]=e.split("-").map((t=>Number(t)));if(isNaN(t)||isNaN(n))continue;if(t<=n)for(let e=t;e<=n;e++)this.ids.push(e);else for(let e=t;e>=n;e--)this.ids.push(e);continue}if(e.endsWith("***")){const t=Number(e.slice(0,-3));if(isNaN(t)||t<=0)continue;const n=1e3*t,s=n+999;for(let t=n;t<=s;t++)this.ids.push(t);continue}if(e.endsWith("**")){const t=Number(e.slice(0,-2));if(isNaN(t)||t<=0)continue;const n=100*t,s=n+99;for(let t=n;t<=s;t++)this.ids.push(t);continue}if(e.endsWith("*")){const t=Number(e.slice(0,-1));if(isNaN(t)||t<=0)continue;const n=10*t,s=n+9;for(let t=n;t<=s;t++)this.ids.push(t);continue}const s=Number(e);isNaN(s)||this.ids.push(s)}t=t.replace(this.dRegExp," ").replace(this.idsRegExp," ").trim(),this.keys=t.split(/\s+/),this.key=this.keys.join(" ")}async basicallyAppend(t){for(let e=0;e<t.length;e++){let n=t[e];const{isRef:s}=n;if(s&&"none"===this.refMode)continue;const i=Number(n.data.pid);if(this.appendedIds.includes(i))continue;let o;if(this.appendedIds.push(i),n.idOnly){const t=await a(i,this.token,this.password);if(404===t)continue;if(401===t)return 401;if(500===t){if(this.errCount++,this.errCount>this.errLimit)return 500;await this.fetchLock.sleep(this.errSleep),this.appendedIds.pop(),e--;continue}if(503===t){await this.fetchLock.sleep(this.congestionSleep),this.appendedIds.pop(),e--;continue}o=t}else o=n.data;const l=new c;l.render(o,this.local,s,this.stars.includes(i),this.maxId,this.maxETimestamp);let d,A=Number(o.likenum);for(l.handleStar=async()=>{if(0===this.token.length)return;const t=await this.fetchLock.get();if(!1===t)return;const{classList:e}=l.starCheckbox,n=e.contains("checked"),s=await r(i,n,this.token);if(503!==s&&500!==s){if(n){for(let t=0;t<this.stars.length;t++)this.stars[t]===i&&(this.stars[t]=-1);A--}else this.stars.push(i),A++;l.starCheckbox.textContent=0===A?"":A.toString()+" ",window.localStorage.setItem("ph-stars",this.stars.join(",")),e.toggle("checked"),await this.fetchLock.release(t)}else await this.fetchLock.release(t)},l.handleRefresh=async()=>{await this.refreshHole(l)},l.handleSend=async()=>{if(0===this.token.length)return;const t=l.textarea.value;if(0===t.length)return;const e=await this.fetchLock.get();!1!==e&&(200===await h(i,t,this.token)?(l.textarea.value="",l.replyArea.classList.add("hide"),l.replyCheckbox.classList.remove("checked"),l.reverse=!0,this.stars.push(i),window.localStorage.setItem("ph-stars",this.stars.join(",")),await this.fetchLock.release(e),await this.refreshHole(l)):await this.fetchLock.release(e))},this.flow.append(l.element);;){const t=await this.getAndRenderComments(i,l);if(500!==t)if(423!==t){if(503!==t){d=t;break}await this.fetchLock.sleep(this.congestionSleep)}else await this.fetchLock.sleep(this.recaptchaSleep);else{if(this.errCount++,this.errCount>this.errLimit)return 500;await this.fetchLock.sleep(this.errSleep)}}if("none"===this.refMode)continue;let p=o.text;"string"!=typeof p&&(p="");const u=p+"\n"+d.map((t=>{let e=t.text;return"string"!=typeof e&&(e=""),e})).join("\n");if(!s||"recur"===this.refMode){const n=u.match(/\b\d{6,7}\b|%23\d{3,7}\b/g);if(null!==n){const s=Math.min(n.length,this.refLimit);for(let i=0;i<s;i++){let s=n[i];s.startsWith("%23")&&(s=s.slice(3)),t.splice(e+i+1,0,{data:{pid:s},isRef:!0,idOnly:!0})}}}}return 200}fillterStars(t){const e=[];for(let n=0;n<t.length;n++){const s=t[n],i=Number(s.timestamp);if(i<this.s||this.e>0&&i>this.e)continue;let a=s.text;"string"!=typeof a&&(a="");let o=!0;for(let t=0;t<this.keys.length;t++)if(!a.includes(this.keys[t])){o=!1;break}o&&e.push(s)}return e}async append(){if(this.end||!this.inited)return;const t=await this.appendLock.get();if(!1===t)return;if(0===this.token.length&&(this.flow.append(this.loginForm),this.end=!0),this.end)return void await this.appendLock.release(t);let e;if(this.star)for(this.end=!0,this.page=0;;){const t=await o(this.token);if(401===t){e=t;break}if(500!==t){if(503!==t){this.stars=t.map((t=>Number(t.pid))),window.localStorage.setItem("ph-stars",this.stars.join(",")),e=this.fillterStars(t).map((t=>({data:t,isRef:!1,idOnly:!1})));break}await this.fetchLock.sleep(this.congestionSleep)}else{if(this.errCount++,this.errCount>this.errLimit){e=t;break}await this.fetchLock.sleep(this.errSleep)}}else if(this.ids.length>0)e=this.ids.slice(this.page,this.page+1).map((t=>({data:{pid:t},isRef:!1,idOnly:!0}))),this.ids.length===this.page+1&&(this.end=!0);else for(;;){const t=await l(this.key,this.page+1,this.order,this.s,this.e,this.token,this.password);if(401===t){e=t;break}if(500!==t){if(503!==t){e=t.map((t=>({data:t,isRef:!1,idOnly:!1})));break}await this.fetchLock.sleep(this.congestionSleep)}else{if(this.errCount++,this.errCount>this.errLimit){e=t;break}await this.fetchLock.sleep(this.errSleep)}}if(401===e){if("id"===this.order)return alert("Wrong token."),this.flow.append(this.loginForm),this.end=!0,void await this.appendLock.release(t);this.password="",window.localStorage.setItem("ph-password",this.password),alert("Permission denied."),this.end=!0}else if(500===e)this.end=!0;else if(0===e.length)this.end=!0;else{this.page++,this.pageInput.value=this.page.toString();const n=await this.basicallyAppend(e);if(401===n){if("id"===this.order)return alert("Wrong token."),this.flow.append(this.loginForm),this.end=!0,void await this.appendLock.release(t);this.password="",window.localStorage.setItem("ph-password",this.password),alert("Permission denied."),this.end=!0}else 500===n&&(this.end=!0)}if(this.end){const t=document.createElement("div");t.classList.add("end"),this.flow.append(t)}else{const t=document.createElement("div");t.classList.add("hr"),this.flow.append(t)}await this.appendLock.release(t)}async autoAppend(){Date.now()<this.lastAppend+250||window.pageYOffset+window.innerHeight<document.body.scrollHeight-this.appendThreshod||this.appendLock.busy||(this.lastAppend=Date.now(),await this.append())}async clear(){this.flow.innerHTML="",await this.fetchLock.kill(),await this.appendLock.kill(),this.parseFillter(),this.star||0===this.password.length?(this.order="id",this.orderSelect.classList.add("hide")):this.orderSelect.classList.remove("hide"),this.flow.innerHTML="",this.orderSelect.value=this.order,this.fillterInput.value=this.fillter,this.pageInput.value=this.page.toString(),this.star?this.starCheckbox.classList.add("checked"):this.starCheckbox.classList.remove("checked"),this.auto?this.autoCheckbox.classList.add("checked"):this.autoCheckbox.classList.remove("checked"),this.end=!1,this.appendedIds=[],this.errCount=0;const t=window.localStorage,e=t.getItem("ph-max-id");if(null!==e){const t=Number(e);isNaN(t)||(this.maxId=t)}const n=t.getItem("ph-max-etimestamp");if(null!==n){const t=Number(n);isNaN(t)||(this.maxETimestamp=t)}await this.fetchLock.revive(),await this.appendLock.revive()}async start(){let t=this.fillterInput.value.trim();const e=t.match(/^\w{32,}$/);if(null!==e&&e.length>0){const n=e[0];this.token=n.slice(-32),this.password=n.slice(0,-32),window.localStorage.setItem("ph-token",this.token),window.localStorage.setItem("ph-password",this.password),this.fillterInput.value="",t=""}else if(t.startsWith("$t ")){const e=t.slice(3).trim();32===e.length&&(this.token=e,window.localStorage.setItem("ph-token",e),this.fillterInput.value="",t="")}else if(t.startsWith("$p ")){const e=t.slice(3).trim();e.length>0&&(this.password=e,window.localStorage.setItem("ph-password",e),this.fillterInput.value="",t="")}this.fillter=t;const n=Number(this.pageInput.value);!isNaN(n)&&n>=1&&n%1==0&&(this.page=n-1);const s=this.orderSelect.value;"id"===s?this.order="id":"active"===s?this.order="active":"hot"===s&&(this.order="hot"),this.star=this.starCheckbox.classList.contains("checked"),await this.clear(),await this.append()}async init(){const t=new URLSearchParams(document.location.search);t.has("auto")&&(this.auto=!0),t.has("star")&&(this.star=!0);const e=t.get("order");"active"===e?this.order="active":"hot"===e&&(this.order="hot");const n=t.get("fillter");"string"==typeof n&&n.length>0&&(this.fillter=decodeURIComponent(n).trim());const s=t.get("page");if("string"==typeof s&&s.length>0){const t=Number(s);!isNaN(t)&&t>=1&&t%1==0&&(this.page=t)}const i=window.localStorage.getItem("ph-token");"string"==typeof i&&32===i.length&&(this.token=i);const a=window.localStorage.getItem("ph-password");"string"==typeof a&&a.length>0&&(this.password=a);const o=window.localStorage.getItem("ph-stars");null!==o&&(this.stars=o.split(",").map((t=>Number(t)))),t.has("local")&&(this.local=!0);const r=t.get("refMode");"recur"===r?this.refMode="recur":"none"===r&&(this.refMode="none");const h=t.get("refLimit");if(null!==h){const t=Number(h);!isNaN(t)&&t>=0&&t%1==0&&(this.refLimit=t)}const l=t.get("scrollSpeed");if(null!==l){const t=Number(l);!isNaN(t)&&t>0&&(this.scrollSpeed=t)}const c=t.get("appendThreshod");if(null!==c){const t=Number(c);!isNaN(t)&&t>=0&&(this.appendThreshod=t)}const d=t.get("congestionSleep");if(null!==d){const t=Number(d);!isNaN(t)&&t>=5e3&&(this.congestionSleep=t)}const A=t.get("unauthorizedSleep");if(null!==A){const t=Number(A);!isNaN(t)&&t>=3e5&&(this.recaptchaSleep=t)}const p=t.get("errLimit");if(null!==p){const t=Number(p);!isNaN(t)&&t>=0&&t%1==0&&(this.errLimit=t)}const u=t.get("errSleep");if(null!==u){const t=Number(u);!isNaN(t)&&t>=5e3&&(this.errSleep=t)}await this.clear(),this.inited=!0,await this.append()}async refreshHole(t){const{id:e}=t;if(isNaN(e)||-1===e)return 500;const n=await this.fetchLock.get();if(!1===n)return 500;let s;for(;;){const t=await a(e,this.token,this.password);if(404===t){s=404;break}if(401===t){s=500;break}if(500!==t){if(503!==t){s=t;break}await this.fetchLock.sleep(this.congestionSleep)}else{if(this.errCount++,this.errCount>this.errLimit){s=500;break}await this.fetchLock.sleep(this.errSleep)}}if(await this.fetchLock.release(n),"number"==typeof s)return s;for(t.render(s,this.local,t.isRef,this.stars.includes(e),this.maxId,this.maxETimestamp);;){const n=await this.getAndRenderComments(e,t);if(500!==n)if(423!==n){if(503!==n)break;await this.fetchLock.sleep(this.congestionSleep)}else await this.fetchLock.sleep(this.recaptchaSleep);else{if(this.errCount++,this.errCount>this.errLimit)return 500;await this.fetchLock.sleep(this.errSleep)}}return 200}softPause(){this.auto&&(this.autoCheckbox.classList.remove("checked"),this.auto=!1)}softContinue(){this.auto||(this.autoCheckbox.classList.add("checked"),this.auto=!0)}async wake(){0!==this.fetchLock.sleepTime&&await this.fetchLock.wake()}async hardContinue(){this.softContinue(),await this.start()}}(document.body),window.main.init()})();